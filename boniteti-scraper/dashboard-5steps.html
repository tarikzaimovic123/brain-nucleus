<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boniteti Scraper - Professional Dashboard</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }
    
    /* Sticky Stepper Navigation */
    .stepper-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 24px;
    }
    
    .stepper {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 8px;
    }
    
    .steps::before {
      content: '';
      position: absolute;
      top: 24px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e5e7eb;
      z-index: -1;
    }
    
    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    
    .step-indicator {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #9ca3af;
      transition: all 0.3s;
      position: relative;
      cursor: pointer;
    }
    
    .step.active .step-indicator {
      border-color: #667eea;
      color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    .step.completed .step-indicator {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }
    
    .step.completed .step-indicator::after {
      content: '✓';
      position: absolute;
      font-size: 20px;
    }
    
    .step.completed .step-indicator span {
      display: none;
    }
    
    .step-label {
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
    }
    
    .step.active .step-label {
      color: #667eea;
    }
    
    .step.completed .step-label {
      color: #333;
    }
    
    .step-progress {
      position: absolute;
      top: 24px;
      left: 0;
      height: 2px;
      background: #667eea;
      transition: width 0.3s;
      z-index: -1;
    }
    
    /* Scrollable Content Area */
    .content-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 100px;
    }
    
    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .step-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .step-content h2 {
      font-size: 24px;
      margin-bottom: 24px;
      color: #333;
    }
    
    /* Step 1: Authentication */
    .auth-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group input.error {
      border-color: #ef4444;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 14px;
      margin-top: 4px;
    }
    
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn {
      padding: 12px 32px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #333;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Activities Tree View */
    .activities-tree {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .tree-item {
      padding: 8px 0;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .tree-item:hover {
      background: #f9fafb;
    }
    
    .tree-item.level-0 {
      font-weight: 600;
      font-size: 16px;
    }
    
    .tree-item.level-1 {
      padding-left: 24px;
      font-size: 14px;
    }
    
    .tree-item.level-2 {
      padding-left: 48px;
      font-size: 13px;
    }
    
    .tree-item.level-3 {
      padding-left: 72px;
      font-size: 12px;
      color: #6b7280;
    }
    
    .tree-expand {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    
    .tree-expand.leaf {
      visibility: hidden;
    }
    
    .tree-code {
      font-weight: 600;
      color: #667eea;
      margin-right: 8px;
    }
    
    .tree-name {
      color: #333;
    }
    
    /* Git-style Diff View */
    .diff-view {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      background: #fafafa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .diff-header {
      background: #f3f4f6;
      padding: 8px 12px;
      margin: -16px -16px 16px -16px;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      color: #333;
    }
    
    .diff-line {
      padding: 4px 8px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .diff-line.added {
      background: #d1fae5;
      color: #065f46;
      position: relative;
    }
    
    .diff-line.added::before {
      content: '+';
      position: absolute;
      left: -12px;
      color: #10b981;
      font-weight: bold;
    }
    
    .diff-line.removed {
      background: #fee2e2;
      color: #991b1b;
      position: relative;
    }
    
    .diff-line.removed::before {
      content: '-';
      position: absolute;
      left: -12px;
      color: #ef4444;
      font-weight: bold;
    }
    
    .diff-line.unchanged {
      color: #6b7280;
    }
    
    .diff-line.modified {
      background: #fef3c7;
      color: #92400e;
    }
    
    .diff-summary {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    
    .diff-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .diff-stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
    }
    
    .diff-stat-value {
      font-size: 18px;
      font-weight: 600;
    }
    
    .diff-stat.added .diff-stat-value {
      color: #10b981;
    }
    
    .diff-stat.removed .diff-stat-value {
      color: #ef4444;
    }
    
    .diff-stat.modified .diff-stat-value {
      color: #f59e0b;
    }
    
    /* Debug Console Styles */
    .debug-console {
      margin: 24px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      background: #f9fafb;
    }
    
    .debug-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      user-select: none;
    }
    
    .debug-header:hover {
      opacity: 0.9;
    }
    
    .debug-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    .debug-toggle {
      transition: transform 0.3s ease;
      font-size: 20px;
    }
    
    .debug-toggle.open {
      transform: rotate(90deg);
    }
    
    .debug-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #1f2937;
      color: #e5e7eb;
    }
    
    .debug-content.open {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .debug-log {
      padding: 16px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .debug-entry {
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }
    
    .debug-entry:before {
      content: '>';
      position: absolute;
      left: 0;
      color: #10b981;
    }
    
    .debug-entry.info {
      color: #60a5fa;
    }
    
    .debug-entry.success {
      color: #10b981;
    }
    
    .debug-entry.error {
      color: #ef4444;
    }
    
    .debug-entry.warning {
      color: #f59e0b;
    }
    
    .debug-timestamp {
      color: #6b7280;
      font-size: 11px;
      margin-right: 8px;
    }
    
    /* Step 4: Scraping Controls */
    .scraping-controls {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .control-row {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .control-row label {
      min-width: 180px;
      font-weight: 600;
    }
    
    .control-row input[type="text"],
    .control-row input[type="number"],
    .control-row input[type="password"] {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .control-row input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .control-row input:disabled {
      background: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .checkbox-wrapper label {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: #667eea;
    }
    
    .info-box {
      background: #f0f9ff;
      border-left: 4px solid #667eea;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    
    .info-box h4 {
      color: #1e40af;
      margin-bottom: 8px;
    }
    
    .info-box p {
      color: #3730a3;
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* Progress Section */
    .progress-section {
      margin-top: 32px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .progress-bar-container {
      background: #f3f4f6;
      border-radius: 12px;
      height: 40px;
      overflow: hidden;
      position: relative;
      margin: 16px 0;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .current-company {
      padding: 12px;
      background: #f9fafb;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    /* Logs Section */
    .logs-section {
      margin-top: 32px;
      border-top: 2px solid #f3f4f6;
      padding-top: 24px;
    }
    
    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .log-filters {
      display: flex;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .logs-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      background: #fafafa;
    }
    
    .log-entry {
      padding: 8px;
      border-bottom: 1px solid #f3f4f6;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .log-time {
      color: #9ca3af;
      min-width: 70px;
      font-size: 11px;
    }
    
    .log-level {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      min-width: 50px;
      text-align: center;
    }
    
    .log-level.info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .log-level.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .log-level.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    /* Results */
    .results-placeholder {
      text-align: center;
      padding: 48px;
    }
    
    .results-placeholder svg {
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
      opacity: 0.3;
    }
    
    .results-placeholder h3 {
      color: #6b7280;
      margin-bottom: 12px;
    }
    
    .results-placeholder p {
      color: #9ca3af;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f4f6;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* Sticky Footer Navigation */
    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
      z-index: 90;
      padding: 16px 24px;
    }
    
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Navigation Buttons */
    .navigation-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .nav-btn {
      padding: 10px 24px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      color: #333;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-btn:hover:not(:disabled) {
      border-color: #667eea;
      color: #667eea;
    }
    
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .nav-btn.next {
      background: #667eea;
      color: white;
      border-color: #667eea;
      margin-left: auto;
    }
    
    .nav-btn.next:hover:not(:disabled) {
      background: #5a67d8;
    }
    
    /* Connection Status */
    .connection-status {
      position: absolute;
      top: 24px;
      right: 24px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 110;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      transition: all 0.2s;
    }
    
    .connection-status:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .connection-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .connection-indicator.connected {
      background: #10b981;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    
    .connection-indicator.disconnected {
      background: #ef4444;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
      animation: none;
    }
    
    /* Session Status */
    .session-status {
      position: absolute;
      top: 64px;
      right: 24px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 110;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      transition: all 0.2s;
    }
    
    .session-status:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .session-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    
    .session-indicator.active {
      background: #10b981;
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
      animation: pulse 2s infinite;
    }
    
    .session-indicator.inactive {
      background: #ef4444;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }
    
    /* Toast Notification */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
    }
    
    .toast {
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideInLeft 0.3s ease;
      border-left: 4px solid #6b7280;
    }
    
    .toast.success {
      border-left-color: #10b981;
    }
    
    .toast.warning {
      border-left-color: #f59e0b;
    }
    
    .toast.error {
      border-left-color: #ef4444;
    }
    
    @keyframes slideInLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    
    function Dashboard() {
      // Recursive component to render category children at any depth
      const CategoryChildren = ({ categories, level = 0 }) => {
        const marginLeft = 32 + (level * 24); // Increase indent for each level
        
        return (
          <div style={{
            marginLeft: `${marginLeft}px`,
            marginTop: '8px'
          }}>
            {categories.map(category => (
              <div key={category.id} style={{marginBottom: '8px'}}>
                {/* Category row */}
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  padding: '10px',
                  borderRadius: '8px',
                  background: category.isEmpty 
                    ? `rgba(254, 226, 226, ${Math.max(0.3, 1 - level * 0.2)})` // Lighter red for deeper levels
                    : `rgba(240, 249, 255, ${Math.max(0.3, 1 - level * 0.2)})`, // Lighter blue for deeper levels
                  border: category.isEmpty 
                    ? '1px solid #fca5a5' 
                    : '1px solid #93c5fd'
                }}>
                  <div style={{flex: 1, fontSize: `${Math.max(12, 14 - level)}px`}}>
                    <span style={{
                      fontWeight: '500', 
                      color: category.isEmpty ? '#dc2626' : '#667eea'
                    }}>
                      {category.code}
                    </span> - {category.name}
                    {category.children && category.children.length > 0 && (
                      <span style={{
                        marginLeft: '8px',
                        fontSize: '11px',
                        color: '#9ca3af'
                      }}>
                        ({category.children.length} pod-kategorija)
                      </span>
                    )}
                  </div>
                  <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                    {/* Show own companies if different from total */}
                    {category.ownCompanyCount > 0 && category.children && category.children.length > 0 && (
                      <span style={{
                        fontSize: '11px',
                        color: '#6b7280',
                        padding: '2px 6px',
                        background: '#f3f4f6',
                        borderRadius: '8px'
                      }}>
                        {category.ownCompanyCount} direktno
                      </span>
                    )}
                    <span style={{
                      background: category.isEmpty 
                        ? '#ef4444' 
                        : '#667eea',
                      color: 'white',
                      padding: '3px 10px',
                      borderRadius: '12px',
                      fontSize: '12px',
                      fontWeight: '600',
                      minWidth: '45px',
                      textAlign: 'center'
                    }}>
                      {category.companyCount || 0} ukupno
                    </span>
                  </div>
                </div>
                
                {/* Render children recursively */}
                {category.children && category.children.length > 0 && (
                  <CategoryChildren categories={category.children} level={level + 1} />
                )}
              </div>
            ))}
          </div>
        );
      };
      
      const [currentStep, setCurrentStep] = useState(1);
      const [isConnected, setIsConnected] = useState(false);
      const [authData, setAuthData] = useState({
        username: 'SR-03150321',
        password: '6413',
        isAuthenticated: false,
        sessionToken: null
      });
      const [sessionStatus, setSessionStatus] = useState({
        isActive: false,
        lastChecked: null,
        isChecking: false
      });
      const [toastMessage, setToastMessage] = useState(null);
      const sessionCheckInterval = useRef(null);
      const [existingActivities, setExistingActivities] = useState({
        loaded: false,
        loading: false,
        activities: [],
        stats: null,
        showDetails: false,
        expandedNodes: new Set(),
        expandedCategories: new Set() // Track which main categories are expanded
      });
      const [fetchedActivities, setFetchedActivities] = useState({
        fetched: false,
        loading: false,
        comparison: null,
        error: null,
        pendingChanges: false,
        appliedChanges: false,
        applyingChanges: false
      });
      const [debugConsole, setDebugConsole] = useState({
        isOpen: false,
        logs: []
      });
      const [scrapingConfig, setScrapingConfig] = useState({
        companies: 100,
        concurrent: 10,
        startId: 65000,
        scrapeAll: false,
        maxCompanies: null,
        loadingMax: false,
        selectedActivities: new Set(),
        activities: [],
        loadingActivities: false,
        companiesPerCategory: 10,
        percentagePerCategory: 10, // Default 10% of companies per category
        scrapeOptions: new Set(['basic']) // Default to basic scraping
      });
      const [scrapingStatus, setScrapingStatus] = useState({
        isRunning: false,
        totalCompanies: 0,
        processedCompanies: 0,
        successCount: 0,
        failedCount: 0,
        skippedCount: 0,
        currentCompany: null,
        progress: 0,
        companiesPerMinute: 0,
        estimatedTimeRemaining: null
      });
      const [logs, setLogs] = useState([]);
      const [logFilter, setLogFilter] = useState('all');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');
      const socketRef = useRef(null);
      
      // Toggle function for accordion categories
      const toggleCategory = (categoryId) => {
        setExistingActivities(prev => {
          const newExpanded = new Set(prev.expandedCategories);
          if (newExpanded.has(categoryId)) {
            newExpanded.delete(categoryId);
          } else {
            newExpanded.add(categoryId);
          }
          return { ...prev, expandedCategories: newExpanded };
        });
      };
      
      // Show toast notification
      const showToast = (message, type = 'info') => {
        setToastMessage({ message, type });
        setTimeout(() => setToastMessage(null), 5000);
      };
      
      // Check Boniteti session status - using useCallback to avoid stale closure
      const checkSessionStatus = useCallback(async () => {
        if (!authData.isAuthenticated) {
          console.log('[DEBUG] Skipping session check - not authenticated');
          return;
        }
        
        console.log('[DEBUG] Checking session with token:', authData.sessionToken ? 'exists' : 'missing');
        setSessionStatus(prev => ({ ...prev, isChecking: true }));
        
        try {
          // Use our server proxy to check session status (bypasses CORS)
          const response = await fetch('http://localhost:3456/api/boniteti/check-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sessionToken: authData.sessionToken
            })
          });
          
          const result = await response.json();
          console.log('[DEBUG] Session check result:', result);
          
          // Update session status based on response
          const isActive = result.success && result.active;
          
          setSessionStatus(prev => {
            const wasActive = prev.isActive;
            if (wasActive && !isActive) {
              // Session just expired
              showToast('⚠️ Boniteti sesija je istekla. Kliknite na Session Status za relogin.', 'warning');
            }
            return {
              isActive,
              lastChecked: new Date(),
              isChecking: false
            };
          });
        } catch (error) {
          // If error, assume session expired
          console.error('Session check error:', error);
          setSessionStatus(prev => {
            const wasActive = prev.isActive;
            if (wasActive) {
              showToast('⚠️ Boniteti sesija je istekla. Kliknite na Session Status za relogin.', 'warning');
            }
            return {
              isActive: false,
              lastChecked: new Date(),
              isChecking: false
            };
          });
        }
      }, [authData.isAuthenticated, authData.sessionToken]); // Dependencies for useCallback
      
      // Handle relogin
      const handleRelogin = async () => {
        console.log('[DEBUG] handleRelogin called with credentials:', {
          username: authData.username,
          password: authData.password ? '***' : 'missing'
        });
        
        if (!authData.username || !authData.password) {
          showToast('❌ Nedostaju kredencijali za relogin', 'error');
          return;
        }
        
        setSessionStatus(prev => ({ ...prev, isChecking: true }));
        
        try {
          console.log('[DEBUG] Sending relogin request...');
          // Use our server proxy to relogin (bypasses CORS)
          const response = await fetch('http://localhost:3456/api/boniteti/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: authData.username,
              password: authData.password
            })
          });
          
          console.log('[DEBUG] Relogin response status:', response.status);
          const result = await response.json();
          console.log('[DEBUG] Relogin result:', result);
          
          if (result.success) {
            // Update session token with new one from server
            setAuthData(prev => ({
              ...prev,
              isAuthenticated: true,
              sessionToken: result.sessionToken
            }));
            
            setSessionStatus({
              isActive: true,
              lastChecked: new Date(),
              isChecking: false
            });
            
            console.log('[DEBUG] Relogin successful, session status updated');
            showToast('✅ Uspješno relogovan na Boniteti', 'success');
            
            // Session checking will restart automatically via useEffect
            // when authData.isAuthenticated changes
          } else {
            throw new Error(result.error || 'Relogin failed');
          }
        } catch (error) {
          console.error('Relogin error:', error);
          showToast('❌ Relogin neuspješan: ' + error.message, 'error');
          setSessionStatus(prev => ({ ...prev, isChecking: false }));
        }
      };
      
      // Debug functions (moved here so they can be used by WebSocket listeners)
      const addDebugLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setDebugConsole(prev => ({
          ...prev,
          logs: [...prev.logs, { message, type, timestamp }]
        }));
      };
      
      const clearDebugLogs = () => {
        setDebugConsole(prev => ({ ...prev, logs: [] }));
      };
      
      const toggleDebugConsole = () => {
        setDebugConsole(prev => ({ ...prev, isOpen: !prev.isOpen }));
      };
      
      // Start session checking when authenticated
      useEffect(() => {
        // Always clear existing interval first
        if (sessionCheckInterval.current) {
          clearInterval(sessionCheckInterval.current);
          sessionCheckInterval.current = null;
        }
        
        if (authData.isAuthenticated) {
          // Initial check after small delay
          setTimeout(() => {
            checkSessionStatus();
          }, 1000);
          
          // Set initial status
          setSessionStatus(prev => ({ ...prev, isActive: true }));
          
          // Set up interval for checking every 5 seconds
          sessionCheckInterval.current = setInterval(() => {
            checkSessionStatus();
          }, 5000); // Check every 5 seconds
          
          console.log('[DEBUG] Session checking started');
        } else {
          // Clear everything when not authenticated
          setSessionStatus({ isActive: false, lastChecked: null, isChecking: false });
          console.log('[DEBUG] Session checking stopped - not authenticated');
        }
        
        return () => {
          if (sessionCheckInterval.current) {
            clearInterval(sessionCheckInterval.current);
            sessionCheckInterval.current = null;
          }
        };
      }, [authData.isAuthenticated, authData.sessionToken]); // Add sessionToken dependency
      
      useEffect(() => {
        // Connect to WebSocket
        const socket = io('http://localhost:3456');
        socketRef.current = socket;
        
        socket.on('connect', () => {
          setIsConnected(true);
        });
        
        socket.on('disconnect', () => {
          setIsConnected(false);
        });
        
        socket.on('status-update', (status) => {
          setScrapingStatus(status);
        });
        
        socket.on('progress-update', (data) => {
          setScrapingStatus(prev => ({
            ...prev,
            progress: data.progress,
            currentCompany: data.current,
            processedCompanies: data.processed,
            companiesPerMinute: data.companiesPerMinute,
            estimatedTimeRemaining: data.eta
          }));
        });
        
        socket.on('company-scraped', (data) => {
          if (data.status === 'success') {
            setScrapingStatus(prev => ({ ...prev, successCount: prev.successCount + 1 }));
          } else if (data.status === 'failed') {
            setScrapingStatus(prev => ({ ...prev, failedCount: prev.failedCount + 1 }));
          } else if (data.status === 'skipped') {
            setScrapingStatus(prev => ({ ...prev, skippedCount: prev.skippedCount + 1 }));
          }
        });
        
        socket.on('log-entry', (log) => {
          setLogs(prev => [...prev.slice(-99), log]);
        });
        
        socket.on('scraping-complete', (data) => {
          setScrapingStatus(prev => ({ ...prev, isRunning: false }));
          if (data.success) {
            // Auto advance to results
            setTimeout(() => setCurrentStep(5), 1000);
          }
        });
        
        // Listen for fetch progress updates
        socket.on('fetch-progress', (data) => {
          if (data.message && data.type) {
            addDebugLog(data.message, data.type);
          }
        });
        
        // Listen for activities comparison updates
        socket.on('activities-log', (data) => {
          if (data.message) {
            // Parse the log message if it contains useful info
            const message = data.message.trim();
            if (message.includes('[INFO]')) {
              addDebugLog(message.replace('[INFO]', '').trim(), 'info');
            } else if (message.includes('[SUCCESS]')) {
              addDebugLog(message.replace('[SUCCESS]', '').trim(), 'success');
            } else if (message.includes('[ERROR]')) {
              addDebugLog(message.replace('[ERROR]', '').trim(), 'error');
            } else if (message.includes('[WARN]')) {
              addDebugLog(message.replace('[WARN]', '').trim(), 'warning');
            }
          }
        });
        
        return () => {
          socket.disconnect();
        };
      }, []);
      
      // Auto-load existing activities when reaching step 2
      useEffect(() => {
        if (currentStep === 2 && !existingActivities.loaded && !existingActivities.loading) {
          loadExistingActivities();
        }
        // Load activity counts for step 4
        if (currentStep === 4 && scrapingConfig.activities.length === 0 && !scrapingConfig.loadingActivities) {
          loadActivityCounts();
        }
      }, [currentStep]);
      
      const handleLogin = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');
        
        if (!authData.username || !authData.password) {
          setError('Molim unesite korisničko ime i lozinku');
          setIsLoading(false);
          return;
        }
        
        try {
          // Use our server proxy to login (bypasses CORS)
          const response = await fetch('http://localhost:3456/api/boniteti/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: authData.username,
              password: authData.password
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            setAuthData(prev => ({
              ...prev,
              isAuthenticated: true,
              sessionToken: result.sessionToken
            }));
            
            // Set session as active
            setSessionStatus({
              isActive: true,
              lastChecked: new Date(),
              isChecking: false
            });
            
            setIsLoading(false);
            showToast('✅ Uspješno prijavljen na Boniteti', 'success');
          } else {
            throw new Error(result.error || 'Login failed');
          }
          
        } catch (error) {
          console.error('Login error:', error);
          setError('Login neuspješan. Provjerite kredencijale.');
          setIsLoading(false);
        }
      };
      
      const loadExistingActivities = async () => {
        setExistingActivities(prev => ({ ...prev, loading: true }));
        
        try {
          // Fetch activities
          const activitiesResponse = await fetch('http://localhost:3456/api/activities');
          const activities = await activitiesResponse.json();
          
          // Fetch statistics
          const statsResponse = await fetch('http://localhost:3456/api/activities/stats');
          const stats = await statsResponse.json();
          
          // Fetch company counts per category
          const companiesResponse = await fetch('http://localhost:3456/api/companies/count-by-activity');
          const companyCounts = await companiesResponse.json();
          
          // Build hierarchical structure with company counts - show ALL categories
          // Recursive function to build tree with all levels
          const buildCategoryTree = (parentActivityId = null) => {
            const categoriesAtLevel = activities.filter(a => {
              // For root level, look for items where parent_id is null
              if (parentActivityId === null) {
                return a.parent_id === null || a.parent_id === undefined;
              }
              // For other levels, parent_id references the parent's activity_id, not id
              return a.parent_id === parentActivityId;
            });
            
            console.log(`[DEBUG] Building tree for parentActivityId=${parentActivityId}, found ${categoriesAtLevel.length} categories`);
            if (parentActivityId && categoriesAtLevel.length > 0) {
              console.log('[DEBUG] Sample child:', categoriesAtLevel[0]);
            }
            
            return categoriesAtLevel.map(category => {
              // Use activity_id for finding children, not id
              const children = buildCategoryTree(category.activity_id);
              
              // Get company count for this category
              const ownCount = companyCounts[category.id] || 0;
              
              // Calculate total including all descendants
              const descendantCount = children.reduce((sum, child) => 
                sum + (child.companyCount || 0), 0
              );
              
              const totalCount = ownCount + descendantCount;
              
              return {
                ...category,
                companyCount: totalCount,
                ownCompanyCount: ownCount, // Companies directly in this category
                isEmpty: totalCount === 0,
                children: children.length > 0 ? children.sort((a, b) => a.code.localeCompare(b.code)) : []
              };
            }).sort((a, b) => a.code.localeCompare(b.code));
          };
          
          const categoriesWithCounts = buildCategoryTree(null);
          
          // Debug: Log the structure to see if children are populated
          console.log('[DEBUG] Categories with children:', 
            categoriesWithCounts.map(c => ({
              code: c.code,
              name: c.name,
              childrenCount: c.children ? c.children.length : 0,
              firstChildCode: c.children && c.children[0] ? c.children[0].code : 'none'
            }))
          );
          
          // Calculate statistics for all levels
          const countAllCategories = (cats) => {
            let count = cats.length;
            cats.forEach(cat => {
              if (cat.children && cat.children.length > 0) {
                count += countAllCategories(cat.children);
              }
            });
            return count;
          };
          
          const countCategoriesWithCompanies = (cats) => {
            let count = 0;
            cats.forEach(cat => {
              if (cat.companyCount > 0) count++;
              if (cat.children && cat.children.length > 0) {
                count += countCategoriesWithCompanies(cat.children);
              }
            });
            return count;
          };
          
          const totalCompanies = Object.values(companyCounts).reduce((sum, count) => sum + count, 0);
          const totalCategoriesCount = countAllCategories(categoriesWithCounts);
          const categoriesWithCompanies = countCategoriesWithCompanies(categoriesWithCounts);
          const emptyCategoriesCount = totalCategoriesCount - categoriesWithCompanies;
          
          console.log('[DEBUG] Activities loaded:', {
            totalActivities: activities.length,
            rootCategories: categoriesWithCounts.length,
            totalCategories: totalCategoriesCount,
            categoriesWithCompanies,
            emptyCategoriesCount,
            totalCompanies,
            companyCounts: Object.keys(companyCounts).length
          });
          
          setExistingActivities(prev => ({
            loaded: true,
            loading: false,
            activities: Array.isArray(activities) ? activities : [],
            categoriesWithCounts: categoriesWithCounts,
            totalCompanies: totalCompanies,
            categoriesWithCompanies: categoriesWithCompanies,
            emptyCategories: emptyCategoriesCount,
            stats: stats,
            showDetails: false,
            expandedNodes: new Set(),
            expandedCategories: prev.expandedCategories || new Set() // Preserve expandedCategories or create new
          }));
        } catch (error) {
          console.error('Failed to load activities:', error);
          setExistingActivities(prev => ({
            ...prev,
            loading: false,
            loaded: true,
            activities: [],
            categoriesWithCounts: [],
            totalCompanies: 0,
            categoriesWithCompanies: 0,
            emptyCategories: 0,
            stats: null
          }));
        }
      };
      
      const applyChangesToDatabase = async () => {
        // Check if session is active before applying changes
        if (!sessionStatus.isActive) {
          showToast('⚠️ Sesija nije aktivna. Molim prijavite se ponovo.', 'warning');
          return;
        }
        
        // PAUSE session checking during apply to avoid conflicts
        if (sessionCheckInterval.current) {
          clearInterval(sessionCheckInterval.current);
          sessionCheckInterval.current = null;
          console.log('[DEBUG] Paused session checking during apply changes');
        }
        
        console.log('[DASHBOARD] Applying changes to database...');
        addDebugLog('Starting database synchronization...', 'info');
        
        // Set applying state
        setFetchedActivities(prev => ({
          ...prev,
          applyingChanges: true
        }));
        
        try {
          // Call API to apply the changes
          const response = await fetch('http://localhost:3456/api/apply-changes', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              comparison: fetchedActivities.comparison,
              stats: fetchedActivities.stats
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to apply changes to database');
          }
          
          const result = await response.json();
          
          addDebugLog('Database synchronization completed successfully ✓', 'success');
          addDebugLog(`${fetchedActivities.stats.new} new activities added`, 'success');
          addDebugLog(`${fetchedActivities.stats.updated} activities updated`, 'success');
          addDebugLog(`${fetchedActivities.stats.deleted} activities removed`, 'success');
          
          // Update state
          setFetchedActivities(prev => ({
            ...prev,
            pendingChanges: false,
            appliedChanges: true,
            applyingChanges: false
          }));
          
          // Reload existing activities to show updated data
          await loadExistingActivities();
          
          // Don't auto-advance - let user click Continue
          addDebugLog('Izmjene primijenjene! Možete nastaviti na sljedeći korak.', 'success');
          
        } catch (error) {
          console.error('[DASHBOARD] Error applying changes:', error);
          addDebugLog(`Error: ${error.message}`, 'error');
          setFetchedActivities(prev => ({
            ...prev,
            applyingChanges: false
          }));
          setError('Failed to apply changes to database');
        } finally {
          // RESTART session checking after apply completes
          if (authData.isAuthenticated && !sessionCheckInterval.current) {
            sessionCheckInterval.current = setInterval(() => {
              checkSessionStatus();
            }, 5000);
            console.log('[DEBUG] Restarted session checking after apply changes');
            
            // Do immediate check to update status
            checkSessionStatus();
          }
        }
      };
      
      const loadActivityCounts = async () => {
        setScrapingConfig(prev => ({ ...prev, loadingActivities: true }));
        
        try {
          const response = await fetch('http://localhost:3456/api/activity-counts');
          const data = await response.json();
          
          if (data.success) {
            setScrapingConfig(prev => ({
              ...prev,
              activities: data.categories || [],
              loadingActivities: false,
              selectedActivities: new Set()
            }));
          } else {
            console.error('Failed to load activity counts:', data.error);
            setScrapingConfig(prev => ({ ...prev, loadingActivities: false }));
          }
        } catch (error) {
          console.error('Failed to load activity counts:', error);
          setScrapingConfig(prev => ({ ...prev, loadingActivities: false }));
        }
      };
      
      const fetchAndCompareActivities = async () => {
        // Check if session is active before fetching
        if (!sessionStatus.isActive) {
          showToast('⚠️ Sesija nije aktivna. Molim prijavite se ponovo.', 'warning');
          return;
        }
        
        // PAUSE session checking during fetch to avoid conflicts
        if (sessionCheckInterval.current) {
          clearInterval(sessionCheckInterval.current);
          sessionCheckInterval.current = null;
          console.log('[DEBUG] Paused session checking during fetch');
        }
        
        console.log('[DASHBOARD] Starting fetch and compare for activities and companies...');
        clearDebugLogs();
        addDebugLog('Početak procesa dohvatanja i poređenja podataka...', 'info');
        
        setFetchedActivities(prev => ({ ...prev, loading: true, error: null }));
        
        try {
          addDebugLog('Provjera autentifikacije sesije...', 'info');
          addDebugLog('Povezivanje sa Boniteti API...', 'info');
          console.log('[DASHBOARD] Sending POST request to /api/compare-activities...');
          
          const response = await fetch('http://localhost:3456/api/compare-activities', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sessionToken: authData.sessionToken  // Send current session to avoid new login
            })
          });
          
          console.log('[DASHBOARD] Response status:', response.status);
          console.log('[DASHBOARD] Response headers:', response.headers);
          addDebugLog(`Odgovor primljen sa statusom: ${response.status}`, response.ok ? 'success' : 'error');
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('[DASHBOARD] Response not OK. Status:', response.status, 'Body:', errorText);
            addDebugLog(`Greška: ${errorText}`, 'error');
            throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
          }
          
          addDebugLog('Parsiranje podataka...', 'info');
          const data = await response.json();
          console.log('[DASHBOARD] Response data:', data);
          
          if (data.stats) {
            addDebugLog(`Dohvaćeno ${data.stats.total} djelatnosti sa Boniteti platforme`, 'success');
            addDebugLog(`Poređenje sa postojećom bazom podataka...`, 'info');
            addDebugLog(`Rezultati poređenja djelatnosti:`, 'info');
            addDebugLog(`  • Nove djelatnosti: ${data.stats.new}`, data.stats.new > 0 ? 'warning' : 'info');
            addDebugLog(`  • Ažurirane djelatnosti: ${data.stats.updated}`, data.stats.updated > 0 ? 'warning' : 'info');
            addDebugLog(`  • Nepromijenjene djelatnosti: ${data.stats.unchanged}`, 'info');
            addDebugLog(`  • Obrisane djelatnosti: ${data.stats.deleted}`, data.stats.deleted > 0 ? 'warning' : 'info');
            
            // Add company statistics if available
            addDebugLog(`Provjera kompanija u bazi podataka...`, 'info');
            addDebugLog(`  • Ukupno kompanija u bazi: 0`, 'info');
            addDebugLog(`  • Kompanije za ažuriranje: 0`, 'info');
          }
          
          if (data.comparison) {
            console.log('[DASHBOARD] Comparison found in response:', data.comparison);
            addDebugLog('Obrađujem rezultate poređenja...', 'info');
            
            // Check if there are any changes
            const hasChanges = data.stats && (
              data.stats.new > 0 || 
              data.stats.updated > 0 || 
              data.stats.deleted > 0
            );
            
            setFetchedActivities({
              fetched: true,
              loading: false,
              comparison: data.comparison,
              stats: data.stats,
              error: null,
              pendingChanges: hasChanges,
              appliedChanges: false
            });
            
            if (!hasChanges) {
              // No changes - don't auto advance
              console.log('[DASHBOARD] No changes detected');
              addDebugLog('Nema izmjena, sve djelatnosti su ažurne', 'success');
              addDebugLog('Možete nastaviti na sljedeći korak kada budete spremni', 'info');
            } else {
              // Has changes - wait for user confirmation
              addDebugLog(`Pronađeno ${data.stats.new} novih, ${data.stats.updated} izmijenjenih, ${data.stats.deleted} obrisanih djelatnosti`, 'warning');
              addDebugLog('Čeka se potvrda korisnika za primjenu izmjena...', 'info');
            }
          } else if (data.success) {
            console.log('[DASHBOARD] Success but no comparison data');
            // Still mark as fetched even without comparison
            setFetchedActivities({
              fetched: true,
              loading: false,
              comparison: null,
              error: null
            });
            await loadExistingActivities();
          } else {
            console.error('[DASHBOARD] No comparison in response, error:', data.error);
            throw new Error(data.error || 'Failed to fetch activities');
          }
        } catch (error) {
          console.error('[DASHBOARD] Error in fetchAndCompareActivities:', error);
          addDebugLog(`Failed: ${error.message}`, 'error');
          
          // Add specific error handling messages
          if (error.message.includes('401') || error.message.includes('403')) {
            addDebugLog('Session expired, attempting automatic re-authentication...', 'warning');
          }
          
          setFetchedActivities(prev => ({
            ...prev,
            loading: false,
            error: error.message
          }));
        } finally {
          // RESTART session checking after fetch completes
          if (authData.isAuthenticated && !sessionCheckInterval.current) {
            sessionCheckInterval.current = setInterval(() => {
              checkSessionStatus();
            }, 5000);
            console.log('[DEBUG] Restarted session checking after fetch');
            
            // Do immediate check to update status
            checkSessionStatus();
          }
        }
      };
      
      const toggleTreeNode = (activityId) => {
        setExistingActivities(prev => {
          const newExpanded = new Set(prev.expandedNodes);
          if (newExpanded.has(activityId)) {
            newExpanded.delete(activityId);
          } else {
            newExpanded.add(activityId);
          }
          return { ...prev, expandedNodes: newExpanded };
        });
      };
      
      const renderActivityTree = () => {
        if (!existingActivities.activities || existingActivities.activities.length === 0) {
          return <p style={{textAlign: 'center', color: '#6b7280'}}>No activities in database</p>;
        }
        
        const buildTree = (parentId = null, level = 0) => {
          return existingActivities.activities
            .filter(a => a.parent_id === parentId)
            .map(activity => {
              const hasChildren = existingActivities.activities.some(a => a.parent_id === activity.activity_id);
              const isExpanded = existingActivities.expandedNodes.has(activity.activity_id);
              
              return (
                <div key={activity.activity_id}>
                  <div 
                    className={`tree-item level-${level}`}
                    onClick={() => hasChildren && toggleTreeNode(activity.activity_id)}
                  >
                    <span className={`tree-expand ${!hasChildren ? 'leaf' : ''}`}>
                      {hasChildren && (isExpanded ? '▼' : '▶')}
                    </span>
                    <span className="tree-code">{activity.code}</span>
                    <span className="tree-name">{activity.name}</span>
                  </div>
                  {hasChildren && isExpanded && buildTree(activity.activity_id, level + 1)}
                </div>
              );
            });
        };
        
        return buildTree();
      };
      
      const renderDiffView = () => {
        if (!fetchedActivities.comparison) return null;
        
        const { comparison } = fetchedActivities;
        
        return (
          <div className="diff-view">
            {/* Activities/Djelatnosti Comparison */}
            <div className="diff-header">
              📂 Poređenje Djelatnosti - Git Style Diff
            </div>
            
            <div className="diff-summary">
              <div className="diff-stat added">
                <span className="diff-stat-label">Dodato</span>
                <span className="diff-stat-value">+{comparison.new.length}</span>
              </div>
              <div className="diff-stat modified">
                <span className="diff-stat-label">Izmijenjeno</span>
                <span className="diff-stat-value">~{comparison.updated.length}</span>
              </div>
              <div className="diff-stat removed">
                <span className="diff-stat-label">Obrisano</span>
                <span className="diff-stat-value">-{comparison.deleted.length}</span>
              </div>
            </div>
            
            {/* New activities */}
            {comparison.new.length > 0 && (
              <>
                <div style={{marginTop: '16px', marginBottom: '8px', fontWeight: '600'}}>
                  Nove djelatnosti:
                </div>
                {comparison.new.map((activity, idx) => (
                  <div key={idx} className="diff-line added">
                    {activity.code} - {activity.name}
                  </div>
                ))}
              </>
            )}
            
            {/* Updated activities */}
            {comparison.updated.length > 0 && (
              <>
                <div style={{marginTop: '16px', marginBottom: '8px', fontWeight: '600'}}>
                  Izmijenjene djelatnosti:
                </div>
                {comparison.updated.map((activity, idx) => (
                  <div key={idx}>
                    {activity.old && activity.old.name !== activity.name && (
                      <>
                        <div className="diff-line removed">
                          {activity.code} - {activity.old.name}
                        </div>
                        <div className="diff-line added">
                          {activity.code} - {activity.name}
                        </div>
                      </>
                    )}
                  </div>
                ))}
              </>
            )}
            
            {/* Deleted activities */}
            {comparison.deleted.length > 0 && (
              <>
                <div style={{marginTop: '16px', marginBottom: '8px', fontWeight: '600'}}>
                  Obrisane djelatnosti:
                </div>
                {comparison.deleted.map((activity, idx) => (
                  <div key={idx} className="diff-line removed">
                    {activity.code} - {activity.name}
                  </div>
                ))}
              </>
            )}
            
            {/* No changes */}
            {comparison.new.length === 0 && 
             comparison.updated.length === 0 && 
             comparison.deleted.length === 0 && (
              <div style={{padding: '24px', textAlign: 'center', color: '#6b7280'}}>
                ✅ Nema izmjena u djelatnostima - baza podataka je ažurna
              </div>
            )}
            
            {/* Companies Comparison Section */}
            <div style={{marginTop: '32px'}}>
              <div className="diff-header">
                🏢 Poređenje Kompanija - Git Style Diff
              </div>
              
              <div className="diff-summary">
                <div className="diff-stat added">
                  <span className="diff-stat-label">Nove kompanije</span>
                  <span className="diff-stat-value">+0</span>
                </div>
                <div className="diff-stat modified">
                  <span className="diff-stat-label">Ažurirane</span>
                  <span className="diff-stat-value">~0</span>
                </div>
                <div className="diff-stat removed">
                  <span className="diff-stat-label">Obrisane</span>
                  <span className="diff-stat-value">-0</span>
                </div>
              </div>
              
              <div style={{padding: '24px', textAlign: 'center', color: '#6b7280'}}>
                ℹ️ Poređenje kompanija će biti dostupno nakon što odaberete djelatnosti za skrejpovanje
              </div>
            </div>
          </div>
        );
      };
      
      const fetchMaxCompanies = async () => {
        try {
          const response = await fetch('https://www.boniteti.me/api/total-companies');
          const data = await response.json();
          return data.total || 65000;
        } catch (error) {
          console.error('Failed to fetch max companies:', error);
          return 65000;
        }
      };
      
      const handleScrapeAllToggle = async () => {
        const newScrapeAll = !scrapingConfig.scrapeAll;
        setScrapingConfig(prev => ({ 
          ...prev, 
          scrapeAll: newScrapeAll,
          loadingMax: newScrapeAll
        }));
        
        if (newScrapeAll) {
          const maxCompanies = await fetchMaxCompanies();
          setScrapingConfig(prev => ({ 
            ...prev, 
            companies: maxCompanies,
            maxCompanies: maxCompanies,
            loadingMax: false
          }));
        } else {
          setScrapingConfig(prev => ({ 
            ...prev, 
            companies: 100,
            maxCompanies: null,
            loadingMax: false
          }));
        }
      };
      
      const startScraping = () => {
        const companiesToScrape = scrapingConfig.scrapeAll 
          ? scrapingConfig.maxCompanies 
          : parseInt(scrapingConfig.companies);
          
        socketRef.current.emit('start-scraping', {
          companies: companiesToScrape,
          concurrent: parseInt(scrapingConfig.concurrent),
          startId: parseInt(scrapingConfig.startId),
          sessionToken: authData.sessionToken,
          testMode: false
        });
      };
      
      const stopScraping = () => {
        if (confirm('Are you sure you want to stop scraping?')) {
          socketRef.current.emit('stop-scraping');
        }
      };
      
      const formatTime = (ms) => {
        if (!ms) return '--';
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
          return `${hours}h ${minutes % 60}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${seconds % 60}s`;
        } else {
          return `${seconds}s`;
        }
      };
      
      const formatLogTime = (time) => {
        const date = new Date(time);
        return date.toLocaleTimeString('en-US', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      };
      
      const filteredLogs = logs.filter(log => {
        if (logFilter === 'all') return true;
        return log.level === logFilter;
      });
      
      const canProceedToNext = () => {
        if (currentStep === 1) return authData.isAuthenticated;
        if (currentStep === 2) return existingActivities.loaded;
        if (currentStep === 3) return fetchedActivities.fetched;
        if (currentStep === 4) return scrapingStatus.processedCompanies > 0 && !scrapingStatus.isRunning;
        return false;
      };
      
      const goToStep = (step) => {
        if (step === 1) {
          setCurrentStep(1);
        } else if (step === 2 && authData.isAuthenticated) {
          setCurrentStep(2);
        } else if (step === 3 && authData.isAuthenticated && existingActivities.loaded) {
          setCurrentStep(3);
        } else if (step === 4 && authData.isAuthenticated && existingActivities.loaded && fetchedActivities.fetched) {
          setCurrentStep(4);
        } else if (step === 5 && authData.isAuthenticated && scrapingConfig.selectedActivities.size > 0) {
          setCurrentStep(5);
        } else if (step === 6 && authData.isAuthenticated && scrapingConfig.selectedActivities.size > 0) {
          setCurrentStep(6);
        } else if (step === 7 && authData.isAuthenticated && scrapingStatus.processedCompanies > 0) {
          setCurrentStep(7);
        }
      };
      
      return (
        <div className="app-container">
          {/* Toast Notification */}
          {toastMessage && (
            <div className="toast-container">
              <div className={`toast ${toastMessage.type}`}>
                {toastMessage.message}
              </div>
            </div>
          )}
          
          {/* Connection Status - Top Right */}
          <div className="connection-status">
            <div className={`connection-indicator ${isConnected ? 'connected' : 'disconnected'}`}></div>
            <span>{isConnected ? 'Connected' : 'Disconnected'}</span>
          </div>
          
          {/* Session Status - Below Connection Status */}
          {authData.isAuthenticated && (
            <div 
              className="session-status"
              onClick={() => {
                console.log('[DEBUG] Session status clicked:', {
                  isActive: sessionStatus.isActive,
                  isChecking: sessionStatus.isChecking,
                  hasCredentials: !!(authData.username && authData.password)
                });
                if (!sessionStatus.isActive && !sessionStatus.isChecking) {
                  handleRelogin();
                }
              }}
              style={{
                cursor: !sessionStatus.isActive && !sessionStatus.isChecking ? 'pointer' : 'default'
              }}
            >
              <div className={`session-indicator ${sessionStatus.isActive ? 'active' : 'inactive'}`}></div>
              <span>
                {sessionStatus.isChecking ? 'Checking...' : 
                 sessionStatus.isActive ? 'Session active' : 'Session inactive (click to relogin)'}
              </span>
            </div>
          )}
          
          {/* Sticky Stepper Navigation */}
          <div className="stepper-container">
            <div className="stepper">
              <div className="steps">
                <div 
                  className={`step ${currentStep === 1 ? 'active' : ''} ${authData.isAuthenticated ? 'completed' : ''}`}
                  onClick={() => goToStep(1)}
                >
                  <div className="step-indicator">
                    <span>1</span>
                  </div>
                  <div className="step-label">Authentication</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 2 ? 'active' : ''} ${existingActivities.loaded && currentStep > 2 ? 'completed' : ''}`}
                  onClick={() => goToStep(2)}
                >
                  <div className="step-indicator">
                    <span>2</span>
                  </div>
                  <div className="step-label">View current data</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 3 ? 'active' : ''} ${fetchedActivities.fetched && currentStep > 3 ? 'completed' : ''}`}
                  onClick={() => goToStep(3)}
                >
                  <div className="step-indicator">
                    <span>3</span>
                  </div>
                  <div className="step-label">Fetch Remote Data & Compare</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 4 ? 'active' : ''} ${scrapingConfig.selectedActivities.size > 0 && currentStep > 4 ? 'completed' : ''}`}
                  onClick={() => goToStep(4)}
                >
                  <div className="step-indicator">
                    <span>4</span>
                  </div>
                  <div className="step-label">Select Categories</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 5 ? 'active' : ''} ${currentStep > 5 ? 'completed' : ''}`}
                  onClick={() => goToStep(5)}
                >
                  <div className="step-indicator">
                    <span>5</span>
                  </div>
                  <div className="step-label">Scraping Config</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 6 ? 'active' : ''} ${scrapingStatus.processedCompanies > 0 && currentStep > 6 ? 'completed' : ''}`}
                  onClick={() => goToStep(6)}
                >
                  <div className="step-indicator">
                    <span>6</span>
                  </div>
                  <div className="step-label">Scraping Companies</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 7 ? 'active' : ''}`}
                  onClick={() => goToStep(7)}
                >
                  <div className="step-indicator">
                    <span>7</span>
                  </div>
                  <div className="step-label">Results</div>
                </div>
                
                <div 
                  className="step-progress" 
                  style={{
                    width: `${((currentStep - 1) / 6) * 100}%`
                  }}
                />
              </div>
            </div>
          </div>
          
          {/* Scrollable Content Area */}
          <div className="content-container">
            <div className="content-wrapper">
              {/* Step 1: Authentication */}
              {currentStep === 1 && (
                <div className="step-content">
                  <h2>🔐 Authenticate with Boniteti</h2>
                  
                  {authData.isAuthenticated ? (
                    <div className="success-message">
                      ✅ Successfully authenticated! Session token obtained.
                    </div>
                  ) : null}
                  
                  <div className="auth-form">
                    <form onSubmit={handleLogin}>
                      <div className="form-group">
                        <label htmlFor="username">Username</label>
                        <input
                          type="text"
                          id="username"
                          placeholder="Enter your Boniteti username"
                          value={authData.username}
                          onChange={(e) => setAuthData(prev => ({ ...prev, username: e.target.value }))}
                          disabled={authData.isAuthenticated}
                          className={error && !authData.username ? 'error' : ''}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label htmlFor="password">Password</label>
                        <input
                          type="password"
                          id="password"
                          placeholder="Enter your password"
                          value={authData.password}
                          onChange={(e) => setAuthData(prev => ({ ...prev, password: e.target.value }))}
                          disabled={authData.isAuthenticated}
                          className={error && !authData.password ? 'error' : ''}
                        />
                      </div>
                      
                      {error && (
                        <div className="error-message">{error}</div>
                      )}
                      
                      {!authData.isAuthenticated && (
                        <button 
                          type="submit" 
                          className="btn btn-primary"
                          disabled={isLoading}
                        >
                          {isLoading ? (
                            <>Authenticating... <span className="spinner"></span></>
                          ) : (
                            'Authenticate'
                          )}
                        </button>
                      )}
                    </form>
                    
                  </div>
                </div>
              )}
              
              {/* Step 2: View Existing Activities */}
              {currentStep === 2 && (
                <div className="step-content">
                  <h2>📂 Djelatnosti i kompanije u našoj bazi podataka</h2>
                  
                  {existingActivities.loading && (
                    <div style={{textAlign: 'center', padding: '48px'}}>
                      <div className="spinner" style={{width: '48px', height: '48px', borderWidth: '4px'}}></div>
                      <p style={{marginTop: '24px', color: '#6b7280'}}>
                        Učitavam kategorije i broj kompanija iz baze podataka...
                      </p>
                    </div>
                  )}
                  
                  {existingActivities.loaded && !existingActivities.loading && (
                    <>
                      {/* Statistics Cards - Database Overview */}
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                        gap: '16px',
                        marginBottom: '32px'
                      }}>
                        <div style={{
                          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                          borderRadius: '16px',
                          padding: '24px',
                          color: 'white',
                          boxShadow: '0 10px 30px rgba(102, 126, 234, 0.3)'
                        }}>
                          <div style={{fontSize: '14px', opacity: 0.9, marginBottom: '8px'}}>Ukupno Kompanija</div>
                          <div style={{fontSize: '36px', fontWeight: 'bold'}}>
                            {existingActivities.totalCompanies?.toLocaleString() || 0}
                          </div>
                          <div style={{fontSize: '12px', opacity: 0.8, marginTop: '4px'}}>
                            U bazi podataka
                          </div>
                        </div>
                        
                        <div style={{
                          background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                          borderRadius: '16px',
                          padding: '24px',
                          color: 'white',
                          boxShadow: '0 10px 30px rgba(16, 185, 129, 0.3)'
                        }}>
                          <div style={{fontSize: '14px', opacity: 0.9, marginBottom: '8px'}}>Kategorije sa kompanijama</div>
                          <div style={{fontSize: '36px', fontWeight: 'bold'}}>
                            {existingActivities.categoriesWithCompanies || 0}
                          </div>
                          <div style={{fontSize: '12px', opacity: 0.8, marginTop: '4px'}}>
                            Aktivne kategorije
                          </div>
                        </div>
                        
                        <div style={{
                          background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                          borderRadius: '16px',
                          padding: '24px',
                          color: 'white',
                          boxShadow: '0 10px 30px rgba(239, 68, 68, 0.3)'
                        }}>
                          <div style={{fontSize: '14px', opacity: 0.9, marginBottom: '8px'}}>Prazne kategorije</div>
                          <div style={{fontSize: '36px', fontWeight: 'bold'}}>
                            {existingActivities.emptyCategories || 0}
                          </div>
                          <div style={{fontSize: '12px', opacity: 0.8, marginTop: '4px'}}>
                            Bez kompanija ⚠️
                          </div>
                        </div>
                        
                        <div style={{
                          background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                          borderRadius: '16px',
                          padding: '24px',
                          color: 'white',
                          boxShadow: '0 10px 30px rgba(245, 158, 11, 0.3)'
                        }}>
                          <div style={{fontSize: '14px', opacity: 0.9, marginBottom: '8px'}}>Ukupno kategorija</div>
                          <div style={{fontSize: '36px', fontWeight: 'bold'}}>
                            {existingActivities.stats?.total || 0}
                          </div>
                          <div style={{fontSize: '12px', opacity: 0.8, marginTop: '4px'}}>
                            Sve kategorije
                          </div>
                        </div>
                      </div>

                      {/* Categories with Company Counts - Show ALL categories */}
                      {existingActivities.categoriesWithCounts && existingActivities.categoriesWithCounts.length > 0 && (
                        <>
                          <h3 style={{marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '16px'}}>
                            📊 Sve kategorije u bazi podataka
                            <div style={{
                              fontSize: '14px',
                              padding: '4px 12px',
                              borderRadius: '20px',
                              background: '#f3f4f6',
                              color: '#6b7280'
                            }}>
                              🟢 {existingActivities.categoriesWithCompanies || 0} sa kompanijama | 
                              🔴 {existingActivities.emptyCategories || 0} praznih
                            </div>
                          </h3>
                          
                          <div style={{
                            display: 'grid',
                            gap: '16px',
                            marginBottom: '24px'
                          }}>
                            {existingActivities.categoriesWithCounts.map(category => (
                              <div key={category.id} style={{
                                border: category.isEmpty ? '2px solid #fee2e2' : '1px solid #e5e7eb',
                                borderRadius: '12px',
                                padding: '16px',
                                background: category.isEmpty ? '#fef2f2' : 'white'
                              }}>
                                {/* Main Category Header - Clickable */}
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  marginBottom: existingActivities.expandedCategories?.has(category.id) && category.children?.length > 0 ? '12px' : '0',
                                  paddingBottom: existingActivities.expandedCategories?.has(category.id) && category.children?.length > 0 ? '12px' : '0',
                                  borderBottom: existingActivities.expandedCategories?.has(category.id) && category.children?.length > 0 ? '2px solid #f3f4f6' : 'none',
                                  cursor: category.children?.length > 0 ? 'pointer' : 'default'
                                }}
                                onClick={() => category.children?.length > 0 && toggleCategory(category.id)}
                                >
                                  <div style={{flex: 1, display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    {/* Accordion arrow */}
                                    {category.children?.length > 0 && (
                                      <span style={{
                                        fontSize: '12px',
                                        color: '#6b7280',
                                        transform: existingActivities.expandedCategories?.has(category.id) ? 'rotate(90deg)' : 'rotate(0deg)',
                                        transition: 'transform 0.2s ease',
                                        display: 'inline-block',
                                        minWidth: '12px'
                                      }}>
                                        ▶
                                      </span>
                                    )}
                                    <div>
                                      <div style={{fontWeight: 'bold', fontSize: '16px', color: '#1f2937'}}>
                                        {category.code} - {category.name}
                                      </div>
                                      {category.fullText && (
                                        <div style={{fontSize: '14px', color: '#6b7280', marginTop: '4px'}}>
                                          {category.fullText}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <div style={{
                                    background: category.companyCount > 0 
                                      ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                                      : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                    color: 'white',
                                    padding: '8px 16px',
                                    borderRadius: '20px',
                                    fontWeight: 'bold',
                                    fontSize: '14px',
                                    minWidth: '140px',
                                    textAlign: 'center',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '6px'
                                  }}>
                                    {category.companyCount === 0 && '⚠️ '}
                                    {category.companyCount?.toLocaleString() || 0} kompanija
                                  </div>
                                </div>

                                {/* Render subcategories - Only if expanded */}
                                {existingActivities.expandedCategories?.has(category.id) && category.children && category.children.length > 0 && (
                                  <div style={{
                                    marginTop: '12px', 
                                    marginLeft: '24px',
                                    animation: 'slideIn 0.3s ease'
                                  }}>
                                    {category.children.map(subcat => (
                                      <div key={subcat.id} style={{
                                        marginBottom: '8px',
                                        padding: '10px',
                                        borderRadius: '8px',
                                        background: subcat.isEmpty 
                                          ? 'rgba(254, 226, 226, 0.5)' 
                                          : 'rgba(240, 249, 255, 0.5)',
                                        border: subcat.isEmpty 
                                          ? '1px solid #fca5a5' 
                                          : '1px solid #93c5fd'
                                      }}>
                                        <div style={{
                                          display: 'flex',
                                          justifyContent: 'space-between',
                                          alignItems: 'center'
                                        }}>
                                          <div>
                                            <span style={{fontWeight: '500', color: subcat.isEmpty ? '#dc2626' : '#667eea'}}>
                                              {subcat.code}
                                            </span> - {subcat.name}
                                          </div>
                                          <div style={{
                                            fontSize: '12px',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            background: subcat.companyCount > 0 ? '#10b981' : '#ef4444',
                                            color: 'white'
                                          }}>
                                            {subcat.companyCount || 0} kompanija
                                          </div>
                                        </div>
                                        
                                        {/* Third level subcategories */}
                                        {subcat.children && subcat.children.length > 0 && (
                                          <div style={{marginTop: '8px', marginLeft: '24px'}}>
                                            {subcat.children.map(subsubcat => (
                                              <div key={subsubcat.id} style={{
                                                marginBottom: '6px',
                                                padding: '8px',
                                                borderRadius: '6px',
                                                background: subsubcat.isEmpty 
                                                  ? 'rgba(254, 226, 226, 0.3)' 
                                                  : 'rgba(240, 249, 255, 0.3)',
                                                border: subsubcat.isEmpty 
                                                  ? '1px solid #fecaca' 
                                                  : '1px solid #bfdbfe',
                                                fontSize: '14px'
                                              }}>
                                                <div style={{
                                                  display: 'flex',
                                                  justifyContent: 'space-between',
                                                  alignItems: 'center'
                                                }}>
                                                  <div>
                                                    <span style={{fontWeight: '500', color: subsubcat.isEmpty ? '#ef4444' : '#3b82f6'}}>
                                                      {subsubcat.code}
                                                    </span> - {subsubcat.name}
                                                  </div>
                                                  <div style={{
                                                    fontSize: '11px',
                                                    padding: '2px 6px',
                                                    borderRadius: '8px',
                                                    background: subsubcat.companyCount > 0 ? '#34d399' : '#f87171',
                                                    color: 'white'
                                                  }}>
                                                    {subsubcat.companyCount || 0}
                                                  </div>
                                                </div>
                                              </div>
                                            ))}
                                          </div>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                      
                      {/* Show message only if we have stats but no categories data */}
                      {existingActivities.stats && existingActivities.stats.total > 0 && 
                       (!existingActivities.categoriesWithCounts || existingActivities.categoriesWithCounts.length === 0) && (
                            <div style={{
                              background: '#f3f4f6',
                              borderRadius: '12px',
                              padding: '16px',
                              marginBottom: '24px'
                            }}>
                              <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: '12px'
                              }}>
                                <h3 style={{margin: 0}}>📊 Rezime Baze Podataka</h3>
                                <div style={{
                                  background: '#10b981',
                                  color: 'white',
                                  padding: '6px 12px',
                                  borderRadius: '20px',
                                  fontSize: '14px',
                                  fontWeight: 'bold'
                                }}>
                                  {existingActivities.stats.total} Ukupno Kategorija
                                </div>
                              </div>
                              <p style={{color: '#6b7280', margin: 0}}>
                                Vaša baza podataka sadrži hijerarhijsku strukturu kategorija aktivnosti sinhronizovanih sa Boniteti.
                              </p>
                            </div>
                      )}
                      
                      {/* Show empty message only if we truly have no data */}
                      {(!existingActivities.stats || existingActivities.stats?.total === 0) && (
                        <div style={{
                          background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                          borderRadius: '16px',
                          padding: '32px',
                          textAlign: 'center',
                          border: '2px solid #fbbf24'
                        }}>
                          <h3 style={{color: '#92400e', marginBottom: '12px'}}>📭 Nema pronađenih kategorija</h3>
                          <p style={{color: '#78350f', fontSize: '16px'}}>
                            Tabela aktivnosti je prazna. Kliknite "Fetch Categories & Compare" u sljedećem koraku da učitate kategorije sa Boniteti API-ja.
                          </p>
                        </div>
                      )}
                      
                    </>
                  )}
                </div>
              )}
              
              {/* Step 3: Fetch & Compare */}
              {currentStep === 3 && (
                <div className="step-content">
                  <h2>🔄 Dohvati & Uporedi Podatke</h2>
                  
                  {!fetchedActivities.fetched && !fetchedActivities.loading && (
                    <div style={{textAlign: 'center', padding: '48px'}}>
                      <p style={{marginBottom: '24px', color: '#6b7280'}}>
                        Klikni ispod da dohvatiš najnovije kompanije i djelatnosti sa Boniteti platforme<br/>
                        i uporediš ih sa podacima iz postojeće baze.
                      </p>
                      <button 
                        className="btn btn-primary"
                        onClick={fetchAndCompareActivities}
                        style={{width: 'auto', padding: '12px 48px'}}
                      >
                        Fetch & Compare
                      </button>
                    </div>
                  )}
                  
                  {fetchedActivities.loading && (
                    <div>
                      <div style={{textAlign: 'center', padding: '48px'}}>
                        <div className="spinner" style={{width: '48px', height: '48px', borderWidth: '4px'}}></div>
                        <p style={{marginTop: '24px', color: '#6b7280'}}>
                          Dohvatam kompanije i djelatnosti sa Boniteti platforme i poredim sa postojećom bazom...
                        </p>
                      </div>
                      
                      {/* Debug Console */}
                      <div className="debug-console">
                        <div className="debug-header" onClick={toggleDebugConsole}>
                          <div className="debug-title">
                            <span>🔧</span>
                            <span>Debug Console</span>
                            <span style={{fontSize: '12px', opacity: 0.8}}>
                              ({debugConsole.logs.length} logs)
                            </span>
                          </div>
                          <span className={`debug-toggle ${debugConsole.isOpen ? 'open' : ''}`}>
                            ▶
                          </span>
                        </div>
                        <div className={`debug-content ${debugConsole.isOpen ? 'open' : ''}`}>
                          <div className="debug-log">
                            {debugConsole.logs.length === 0 ? (
                              <div className="debug-entry info">
                                <span className="debug-timestamp">{new Date().toLocaleTimeString()}</span>
                                Waiting for process to start...
                              </div>
                            ) : (
                              debugConsole.logs.map((log, index) => (
                                <div key={index} className={`debug-entry ${log.type}`}>
                                  <span className="debug-timestamp">{log.timestamp}</span>
                                  {log.message}
                                </div>
                              ))
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {fetchedActivities.error && (
                    <div>
                      <div className="error-message" style={{margin: '24px', padding: '16px'}}>
                        Error: {fetchedActivities.error}
                        <button 
                          className="btn btn-secondary"
                          onClick={fetchAndCompareActivities}
                          style={{marginTop: '12px'}}
                        >
                          Try Again
                        </button>
                      </div>
                      
                      {/* Show debug console on error to help troubleshoot */}
                      {debugConsole.logs.length > 0 && (
                        <div className="debug-console">
                          <div className="debug-header" onClick={toggleDebugConsole}>
                            <div className="debug-title">
                              <span>🔧</span>
                              <span>Debug Console - Check what went wrong</span>
                            </div>
                            <span className={`debug-toggle ${debugConsole.isOpen ? 'open' : ''}`}>
                              ▶
                            </span>
                          </div>
                          <div className={`debug-content ${debugConsole.isOpen ? 'open' : ''}`}>
                            <div className="debug-log">
                              {debugConsole.logs.map((log, index) => (
                                <div key={index} className={`debug-entry ${log.type}`}>
                                  <span className="debug-timestamp">{log.timestamp}</span>
                                  {log.message}
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {fetchedActivities.fetched && !fetchedActivities.loading && (
                    <>
                      <div className="success-message">
                        ✅ Uspješno dohvaćeni i upoređeni podaci o djelatnostima i kompanijama!
                      </div>
                      
                      {renderDiffView()}
                      
                      {/* Show confirmation prompt if there are pending changes */}
                      {fetchedActivities.pendingChanges && !fetchedActivities.appliedChanges && (
                        <div style={{
                          marginTop: '24px', 
                          padding: '24px', 
                          background: fetchedActivities.applyingChanges 
                            ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                            : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                          borderRadius: '12px',
                          color: 'white',
                          textAlign: 'center',
                          transition: 'all 0.3s ease',
                          transform: fetchedActivities.applyingChanges ? 'scale(0.98)' : 'scale(1)'
                        }}>
                          {!fetchedActivities.applyingChanges ? (
                            <>
                              <h3 style={{marginBottom: '16px', fontSize: '20px', fontWeight: '600'}}>
                                🔄 Sinhronizuj sa bazom podataka?
                              </h3>
                              <p style={{marginBottom: '24px', opacity: 0.95}}>
                                Pronađene su izmjene koje treba primijeniti:<br/>
                                <strong style={{fontSize: '18px'}}>
                                  {fetchedActivities.stats?.new > 0 && `${fetchedActivities.stats.new} novih • `}
                                  {fetchedActivities.stats?.updated > 0 && `${fetchedActivities.stats.updated} izmijenjenih • `}
                                  {fetchedActivities.stats?.deleted > 0 && `${fetchedActivities.stats.deleted} obrisanih • `}
                                </strong>
                              </p>
                              <div style={{display: 'flex', gap: '16px', justifyContent: 'center'}}>
                                <button 
                                  className="btn"
                                  onClick={applyChangesToDatabase}
                                  style={{
                                    background: 'white',
                                    color: '#667eea',
                                    padding: '12px 32px',
                                    fontWeight: '600',
                                    fontSize: '16px',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.target.style.transform = 'scale(1.05)';
                                    e.target.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.target.style.transform = 'scale(1)';
                                    e.target.style.boxShadow = 'none';
                                  }}
                                >
                                  ✅ Da, primijeni izmjene
                                </button>
                                <button 
                                  className="btn"
                                  onClick={() => setCurrentStep(4)}
                                  style={{
                                    background: 'rgba(255,255,255,0.2)',
                                    color: 'white',
                                    border: '2px solid white',
                                    padding: '12px 32px',
                                    fontWeight: '600',
                                    fontSize: '16px',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.target.style.background = 'rgba(255,255,255,0.3)';
                                    e.target.style.transform = 'scale(1.05)';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.target.style.background = 'rgba(255,255,255,0.2)';
                                    e.target.style.transform = 'scale(1)';
                                  }}
                                >
                                  ⏭️ Preskoči
                                </button>
                              </div>
                            </>
                          ) : (
                            <>
                              <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '20px'
                              }}>
                                <div className="spinner" style={{
                                  width: '60px',
                                  height: '60px',
                                  borderWidth: '4px',
                                  borderColor: 'white',
                                  borderTopColor: 'transparent'
                                }}></div>
                                <h3 style={{fontSize: '20px', fontWeight: '600', margin: 0}}>
                                  🔄 Primjenjujem izmjene...
                                </h3>
                                <div style={{opacity: 0.9}}>
                                  <p style={{marginBottom: '8px'}}>Sinhronizacija u toku:</p>
                                  <div style={{
                                    display: 'flex',
                                    gap: '20px',
                                    justifyContent: 'center',
                                    fontSize: '14px'
                                  }}>
                                    {fetchedActivities.stats?.new > 0 && (
                                      <div>
                                        <span style={{fontSize: '20px'}}>➕</span><br/>
                                        {fetchedActivities.stats.new} novih
                                      </div>
                                    )}
                                    {fetchedActivities.stats?.updated > 0 && (
                                      <div>
                                        <span style={{fontSize: '20px'}}>✏️</span><br/>
                                        {fetchedActivities.stats.updated} izmijenjenih
                                      </div>
                                    )}
                                    {fetchedActivities.stats?.deleted > 0 && (
                                      <div>
                                        <span style={{fontSize: '20px'}}>🗑️</span><br/>
                                        {fetchedActivities.stats.deleted} obrisanih
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <p style={{fontSize: '14px', opacity: 0.8, margin: 0}}>
                                  Molim sačekajte...
                                </p>
                              </div>
                            </>
                          )}
                        </div>
                      )}
                      
                      {/* Show success message after changes are applied */}
                      {fetchedActivities.appliedChanges && (
                        <div style={{
                          marginTop: '24px', 
                          padding: '20px', 
                          background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', 
                          color: 'white',
                          borderRadius: '12px',
                          textAlign: 'center',
                          fontWeight: '600',
                          animation: 'slideIn 0.5s ease',
                          boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)'
                        }}>
                          <div style={{fontSize: '24px', marginBottom: '8px'}}>
                            ✅
                          </div>
                          <div style={{fontSize: '18px', marginBottom: '8px'}}>
                            Izmjene su uspješno primijenjene!
                          </div>
                          <div style={{fontSize: '14px', opacity: 0.9}}>
                            Baza podataka je ažurirana
                          </div>
                        </div>
                      )}
                      
                      {/* Show info if no changes */}
                      {!fetchedActivities.pendingChanges && !fetchedActivities.appliedChanges && (
                        <div style={{marginTop: '24px', padding: '16px', background: '#f9fafb', borderRadius: '8px'}}>
                          <p style={{fontSize: '14px', color: '#6b7280', textAlign: 'center'}}>
                            Nema izmjena - baza podataka je već ažurna.
                          </p>
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}
              
              {/* Step 4: Scraping */}
              {currentStep === 4 && (
                <div className="step-content">
                  <h2>🔍 Select Activity Categories for Scraping</h2>
                  
                  {scrapingConfig.loadingActivities ? (
                    <div style={{textAlign: 'center', padding: '48px'}}>
                      <div className="spinner" style={{width: '48px', height: '48px', borderWidth: '4px'}}></div>
                      <p style={{marginTop: '24px', color: '#6b7280'}}>
                        Loading activity categories and company counts...
                      </p>
                    </div>
                  ) : (
                    <>
                      {/* Selection Controls - Sticky Header */}
                      <div style={{
                        position: 'sticky',
                        top: '0',
                        zIndex: 10,
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '24px',
                        padding: '16px',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        borderRadius: '12px',
                        color: 'white',
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                      }}>
                        <div style={{display: 'flex', gap: '12px'}}>
                          <button
                            className="btn"
                            style={{
                              background: 'rgba(255,255,255,0.2)',
                              color: 'white',
                              border: '1px solid rgba(255,255,255,0.3)'
                            }}
                            onClick={() => {
                              const allIds = scrapingConfig.activities.flatMap(cat => 
                                [cat.id, ...cat.children.map(c => c.id)]
                              );
                              setScrapingConfig(prev => ({
                                ...prev,
                                selectedActivities: new Set(allIds)
                              }));
                            }}
                          >
                            ✅ Select All
                          </button>
                          <button
                            className="btn"
                            style={{
                              background: 'rgba(255,255,255,0.2)',
                              color: 'white',
                              border: '1px solid rgba(255,255,255,0.3)'
                            }}
                            onClick={() => {
                              setScrapingConfig(prev => ({
                                ...prev,
                                selectedActivities: new Set()
                              }));
                            }}
                          >
                            ❌ Deselect All
                          </button>
                        </div>
                        <div style={{fontSize: '18px', fontWeight: 'bold'}}>
                          Selected: {scrapingConfig.selectedActivities.size} categories
                          {scrapingConfig.selectedActivities.size > 0 && (() => {
                            const totalCompanies = scrapingConfig.activities.reduce((total, cat) => {
                              // If root category is selected, use its total count (includes all subcategories)
                              if (scrapingConfig.selectedActivities.has(cat.id)) {
                                return total + cat.companyCount;
                              }
                              // Otherwise, only count selected subcategories
                              let subcatTotal = 0;
                              cat.children?.forEach(subcat => {
                                if (scrapingConfig.selectedActivities.has(subcat.id)) {
                                  subcatTotal += subcat.companyCount;
                                }
                              });
                              return total + subcatTotal;
                            }, 0);
                            return ` (${totalCompanies.toLocaleString()} companies)`;
                          })()}
                        </div>
                      </div>

                      {/* Activity Categories Grid */}
                      <div style={{
                        display: 'grid',
                        gap: '16px',
                        marginBottom: '24px'
                      }}>
                        {scrapingConfig.activities.map(category => (
                          <div key={category.id} style={{
                            border: '1px solid #e5e7eb',
                            borderRadius: '12px',
                            padding: '16px',
                            background: 'white'
                          }}>
                            {/* Main Category */}
                            <div style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              marginBottom: '12px',
                              paddingBottom: '12px',
                              borderBottom: '2px solid #f3f4f6'
                            }}>
                              <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                cursor: 'pointer',
                                flex: 1
                              }}>
                                <input
                                  type="checkbox"
                                  checked={scrapingConfig.selectedActivities.has(category.id)}
                                  onChange={(e) => {
                                    const newSelected = new Set(scrapingConfig.selectedActivities);
                                    if (e.target.checked) {
                                      newSelected.add(category.id);
                                      // Also select all children
                                      category.children.forEach(child => newSelected.add(child.id));
                                    } else {
                                      newSelected.delete(category.id);
                                      // Also deselect all children
                                      category.children.forEach(child => newSelected.delete(child.id));
                                    }
                                    setScrapingConfig(prev => ({
                                      ...prev,
                                      selectedActivities: newSelected
                                    }));
                                  }}
                                  style={{width: '20px', height: '20px'}}
                                />
                                <div>
                                  <div style={{fontWeight: 'bold', fontSize: '16px', color: '#1f2937'}}>
                                    {category.code} - {category.name}
                                  </div>
                                  <div style={{fontSize: '14px', color: '#6b7280', marginTop: '4px'}}>
                                    {category.fullText}
                                  </div>
                                </div>
                              </label>
                              <div style={{
                                background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                color: 'white',
                                padding: '6px 12px',
                                borderRadius: '20px',
                                fontWeight: 'bold',
                                fontSize: '14px',
                                minWidth: '100px',
                                textAlign: 'center'
                              }}>
                                {category.companyCount.toLocaleString()} companies
                              </div>
                            </div>

                            {/* Subcategories */}
                            {category.children && category.children.length > 0 && (
                              <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                                gap: '8px',
                                marginLeft: '32px'
                              }}>
                                {category.children.map(subcat => (
                                  <label key={subcat.id} style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '8px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    transition: 'background 0.2s',
                                    background: scrapingConfig.selectedActivities.has(subcat.id) 
                                      ? '#f0f9ff' : 'transparent'
                                  }}
                                  onMouseEnter={(e) => {
                                    if (!scrapingConfig.selectedActivities.has(subcat.id)) {
                                      e.currentTarget.style.background = '#f9fafb';
                                    }
                                  }}
                                  onMouseLeave={(e) => {
                                    if (!scrapingConfig.selectedActivities.has(subcat.id)) {
                                      e.currentTarget.style.background = 'transparent';
                                    }
                                  }}>
                                    <input
                                      type="checkbox"
                                      checked={scrapingConfig.selectedActivities.has(subcat.id)}
                                      onChange={(e) => {
                                        const newSelected = new Set(scrapingConfig.selectedActivities);
                                        if (e.target.checked) {
                                          newSelected.add(subcat.id);
                                        } else {
                                          newSelected.delete(subcat.id);
                                        }
                                        setScrapingConfig(prev => ({
                                          ...prev,
                                          selectedActivities: newSelected
                                        }));
                                      }}
                                    />
                                    <div style={{flex: 1, fontSize: '14px'}}>
                                      <span style={{fontWeight: '500'}}>{subcat.code}</span> - {subcat.name}
                                    </div>
                                    {subcat.companyCount > 0 && (
                                      <span style={{
                                        background: '#e5e7eb',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                      }}>
                                        {subcat.companyCount}
                                      </span>
                                    )}
                                  </label>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>

                      {/* Scraping Configuration */}
                      {scrapingConfig.selectedActivities.size > 0 && (
                        <div style={{
                          background: '#f9fafb',
                          borderRadius: '12px',
                          padding: '24px',
                          border: '1px solid #e5e7eb'
                        }}>
                          <h3 style={{marginBottom: '16px'}}>⚙️ Scraping Configuration</h3>
                          
                          <div className="control-row">
                            <label>Companies per Category:</label>
                            <input 
                              type="number" 
                              value={scrapingConfig.companiesPerCategory}
                              onChange={(e) => setScrapingConfig(prev => ({ 
                                ...prev, 
                                companiesPerCategory: parseInt(e.target.value) || 10
                              }))}
                              disabled={scrapingStatus.isRunning}
                              min="1"
                              max="1000"
                            />
                          </div>
                          
                          <div className="control-row">
                            <label>Concurrent Requests:</label>
                            <input 
                              type="number" 
                              value={scrapingConfig.concurrent}
                              onChange={(e) => setScrapingConfig(prev => ({ 
                                ...prev, 
                                concurrent: parseInt(e.target.value) || 10
                              }))}
                              disabled={scrapingStatus.isRunning}
                              min="1"
                              max="50"
                            />
                          </div>
                          
                          <div style={{marginTop: '24px'}}>
                            {!scrapingStatus.isRunning ? (
                              <button 
                                className="btn btn-primary" 
                                onClick={startScraping}
                                style={{width: '100%'}}
                              >
                                🚀 Start Scraping
                              </button>
                            ) : (
                              <button 
                                className="btn btn-danger" 
                                onClick={stopScraping} 
                                style={{width: '100%'}}
                              >
                                ⏹️ Stop Scraping
                              </button>
                            )}
                          </div>
                          
                          <div style={{
                            marginTop: '16px',
                            padding: '12px',
                            background: '#fef3c7',
                            borderRadius: '8px',
                            fontSize: '14px'
                          }}>
                            <strong>📌 Note:</strong> Scraping will collect data about companies from selected activity categories.
                            Up to {scrapingConfig.selectedActivities.size * scrapingConfig.companiesPerCategory} companies will be scraped in total.
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}
              
              {/* Step 5: Scraping Configuration */}
              {currentStep === 5 && (
                <div className="step-content">
                  <h2>⚙️ Scraping Configuration</h2>
                  
                  {/* Concurrent Requests Section */}
                  <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: '16px',
                    padding: '24px',
                    marginBottom: '32px',
                    color: 'white'
                  }}>
                    <h3 style={{marginBottom: '16px', fontSize: '20px'}}>
                      ⚡ Concurrent Requests
                    </h3>
                    <p style={{marginBottom: '16px', opacity: 0.9}}>
                      Koliko paralelnih agenata će skrejpovati podatke. Veći broj znači brže prikupljanje, ali može opteretiti server.
                    </p>
                    <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                      <input 
                        type="range"
                        min="1"
                        max="20"
                        value={scrapingConfig.concurrent}
                        onChange={(e) => setScrapingConfig(prev => ({ 
                          ...prev, 
                          concurrent: parseInt(e.target.value)
                        }))}
                        style={{
                          flex: 1,
                          height: '8px',
                          borderRadius: '4px',
                          background: 'rgba(255,255,255,0.3)',
                          outline: 'none'
                        }}
                      />
                      <div style={{
                        minWidth: '60px',
                        textAlign: 'center',
                        fontSize: '24px',
                        fontWeight: 'bold',
                        background: 'rgba(255,255,255,0.2)',
                        padding: '8px 16px',
                        borderRadius: '8px'
                      }}>
                        {scrapingConfig.concurrent}
                      </div>
                    </div>
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      marginTop: '8px',
                      fontSize: '12px',
                      opacity: 0.7
                    }}>
                      <span>Sporije (1)</span>
                      <span>Optimalno (5-10)</span>
                      <span>Brže (20)</span>
                    </div>
                    
                    {/* Percentage per Category */}
                    <div style={{marginTop: '24px', paddingTop: '24px', borderTop: '1px solid rgba(255,255,255,0.2)'}}>
                      <h4 style={{marginBottom: '12px', fontSize: '16px'}}>
                        📈 Procenat kompanija po kategoriji
                      </h4>
                      <p style={{marginBottom: '16px', opacity: 0.9, fontSize: '14px'}}>
                        Koliki procenat kompanija iz svake kategorije želiš da skrejpuješ
                      </p>
                      <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                        <input 
                          type="range"
                          min="1"
                          max="100"
                          value={scrapingConfig.percentagePerCategory || 10}
                          onChange={(e) => setScrapingConfig(prev => ({ 
                            ...prev, 
                            percentagePerCategory: parseInt(e.target.value)
                          }))}
                          style={{
                            flex: 1,
                            height: '8px',
                            borderRadius: '4px',
                            background: 'rgba(255,255,255,0.3)',
                            outline: 'none'
                          }}
                        />
                        <div style={{
                          minWidth: '70px',
                          textAlign: 'center',
                          fontSize: '24px',
                          fontWeight: 'bold',
                          background: 'rgba(255,255,255,0.2)',
                          padding: '8px 16px',
                          borderRadius: '8px'
                        }}>
                          {scrapingConfig.percentagePerCategory || 10}%
                        </div>
                      </div>
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        marginTop: '8px',
                        fontSize: '12px',
                        opacity: 0.7
                      }}>
                        <span>1% (malo)</span>
                        <span>10-20% (uzorak)</span>
                        <span>50% (pola)</span>
                        <span>100% (sve)</span>
                      </div>
                    </div>
                  </div>

                  {/* Data Types to Scrape Section */}
                  <div style={{
                    background: 'white',
                    borderRadius: '16px',
                    padding: '24px',
                    border: '2px solid #e5e7eb'
                  }}>
                    <h3 style={{marginBottom: '8px', fontSize: '20px', color: '#1f2937'}}>
                      📊 Šta želiš da skrejpuješ?
                    </h3>
                    <p style={{marginBottom: '24px', color: '#6b7280'}}>
                      Izaberi koje podatke želiš da prikupiš. Neki podaci su dostupni preko API-ja, a neki se moraju preuzeti iz HTML stranica.
                    </p>

                    {/* Select/Deselect All Buttons */}
                    <div style={{
                      display: 'flex',
                      gap: '12px',
                      marginBottom: '20px'
                    }}>
                      <button
                        className="btn"
                        style={{
                          background: '#10b981',
                          color: 'white',
                          padding: '8px 16px',
                          fontSize: '14px'
                        }}
                        onClick={() => {
                          const allOptions = [
                            'basic', 'bonitet', 'rezultati', 'zastupnici', 'vlasnicka',
                            'registracija', 'finansijski', 'imovina', 'lizing', 'zaloge',
                            'racuni', 'ogranci', 'tenderi', 'trgovina', 'sporovi', 'blokade'
                          ];
                          setScrapingConfig(prev => ({
                            ...prev,
                            scrapeOptions: new Set(allOptions)
                          }));
                        }}
                      >
                        ✅ Selektuj sve
                      </button>
                      <button
                        className="btn"
                        style={{
                          background: '#ef4444',
                          color: 'white',
                          padding: '8px 16px',
                          fontSize: '14px'
                        }}
                        onClick={() => {
                          setScrapingConfig(prev => ({
                            ...prev,
                            scrapeOptions: new Set()
                          }));
                        }}
                      >
                        ❌ Poništi selekciju
                      </button>
                    </div>

                    {/* Scraping Options Grid */}
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                      gap: '12px'
                    }}>
                      {[
                        { id: 'basic', label: 'Basic scraping', desc: 'Osnovni podaci o kompaniji', api: true },
                        { id: 'bonitet', label: 'Bonitet preduzeća', desc: 'Kreditni rejting i bonitet', api: true },
                        { id: 'rezultati', label: 'Rezultati poslovanja', desc: 'Finansijski rezultati', api: true },
                        { id: 'zastupnici', label: 'Zakonski zastupnici', desc: 'Informacije o zastupnicima', api: false },
                        { id: 'vlasnicka', label: 'Vlasnička struktura', desc: 'Struktura vlasništva', api: false },
                        { id: 'registracija', label: 'Registracioni podaci', desc: 'Podaci o registraciji', api: true },
                        { id: 'finansijski', label: 'Detaljni finansijski podaci', desc: 'Kompletni finansijski izveštaji', api: false },
                        { id: 'imovina', label: 'Imovina', desc: 'Podaci o imovini', api: false },
                        { id: 'lizing', label: 'Lizing', desc: 'Lizing ugovori', api: false },
                        { id: 'zaloge', label: 'Zaloge', desc: 'Podaci o zalogama', api: false },
                        { id: 'racuni', label: 'Tekući računi', desc: 'Bankovni računi', api: false },
                        { id: 'ogranci', label: 'Ogranci', desc: 'Lista ogranaka', api: false },
                        { id: 'tenderi', label: 'Tenderi', desc: 'Učešće u tenderima', api: false },
                        { id: 'trgovina', label: 'Spoljna trgovina', desc: 'Uvoz/izvoz podaci', api: false },
                        { id: 'sporovi', label: 'Sudski sporovi', desc: 'Aktivni sporovi', api: false },
                        { id: 'blokade', label: 'Blokade', desc: 'Blokade računa', api: false }
                      ].map(option => (
                        <label
                          key={option.id}
                          style={{
                            display: 'flex',
                            alignItems: 'flex-start',
                            padding: '12px',
                            borderRadius: '8px',
                            border: '1px solid #e5e7eb',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            background: (scrapingConfig.scrapeOptions?.has(option.id)) ? '#f0f9ff' : 'white'
                          }}
                          onMouseEnter={(e) => {
                            if (!scrapingConfig.scrapeOptions?.has(option.id)) {
                              e.currentTarget.style.background = '#f9fafb';
                            }
                          }}
                          onMouseLeave={(e) => {
                            if (!scrapingConfig.scrapeOptions?.has(option.id)) {
                              e.currentTarget.style.background = 'white';
                            }
                          }}
                        >
                          <input
                            type="checkbox"
                            checked={scrapingConfig.scrapeOptions?.has(option.id) || false}
                            onChange={(e) => {
                              const newOptions = new Set(scrapingConfig.scrapeOptions || []);
                              if (e.target.checked) {
                                newOptions.add(option.id);
                              } else {
                                newOptions.delete(option.id);
                              }
                              setScrapingConfig(prev => ({
                                ...prev,
                                scrapeOptions: newOptions
                              }));
                            }}
                            style={{marginRight: '12px', marginTop: '2px'}}
                          />
                          <div style={{flex: 1}}>
                            <div style={{
                              fontWeight: '500',
                              color: '#1f2937',
                              marginBottom: '4px',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}>
                              {option.label}
                              {option.api && (
                                <span style={{
                                  background: '#10b981',
                                  color: 'white',
                                  fontSize: '10px',
                                  padding: '2px 6px',
                                  borderRadius: '4px',
                                  fontWeight: 'bold'
                                }}>
                                  API
                                </span>
                              )}
                            </div>
                            <div style={{fontSize: '12px', color: '#6b7280'}}>
                              {option.desc}
                            </div>
                          </div>
                        </label>
                      ))}
                    </div>

                    {/* Summary */}
                    <div style={{
                      marginTop: '24px',
                      padding: '16px',
                      background: '#f9fafb',
                      borderRadius: '8px'
                    }}>
                      <h4 style={{margin: '0 0 12px 0', color: '#1f2937'}}>Rezime konfiguracije</h4>
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                        gap: '12px'
                      }}>
                        <div>
                          <span style={{color: '#6b7280', fontSize: '12px'}}>Tipovi podataka</span>
                          <div style={{fontWeight: 'bold', color: '#1f2937'}}>
                            {scrapingConfig.scrapeOptions?.size || 0} izabrano
                          </div>
                        </div>
                        <div>
                          <span style={{color: '#6b7280', fontSize: '12px'}}>Paralelni agenti</span>
                          <div style={{fontWeight: 'bold', color: '#1f2937'}}>
                            {scrapingConfig.concurrent} agenata
                          </div>
                        </div>
                        <div>
                          <span style={{color: '#6b7280', fontSize: '12px'}}>Kategorije aktivnosti</span>
                          <div style={{fontWeight: 'bold', color: '#1f2937'}}>
                            {scrapingConfig.selectedActivities.size} kategorija
                          </div>
                        </div>
                        <div>
                          <span style={{color: '#6b7280', fontSize: '12px'}}>Ukupno kompanija</span>
                          <div style={{fontWeight: 'bold', color: '#1f2937'}}>
                            {(() => {
                              const totalSelected = scrapingConfig.activities.reduce((total, cat) => {
                                if (scrapingConfig.selectedActivities.has(cat.id)) {
                                  return total + cat.companyCount;
                                }
                                let subcatTotal = 0;
                                cat.children?.forEach(subcat => {
                                  if (scrapingConfig.selectedActivities.has(subcat.id)) {
                                    subcatTotal += subcat.companyCount;
                                  }
                                });
                                return total + subcatTotal;
                              }, 0);
                              const toScrape = Math.ceil(totalSelected * (scrapingConfig.percentagePerCategory / 100));
                              return toScrape;
                            })()}
                          </div>
                        </div>
                        <div style={{
                          background: '#667eea',
                          color: 'white',
                          padding: '8px',
                          borderRadius: '6px',
                          textAlign: 'center'
                        }}>
                          <span style={{fontSize: '12px', opacity: 0.9}}>Kompanija po agentu</span>
                          <div style={{fontWeight: 'bold', fontSize: '18px'}}>
                            {Math.ceil((() => {
                              const totalSelected = scrapingConfig.activities.reduce((total, cat) => {
                                if (scrapingConfig.selectedActivities.has(cat.id)) {
                                  return total + cat.companyCount;
                                }
                                let subcatTotal = 0;
                                cat.children?.forEach(subcat => {
                                  if (scrapingConfig.selectedActivities.has(subcat.id)) {
                                    subcatTotal += subcat.companyCount;
                                  }
                                });
                                return total + subcatTotal;
                              }, 0);
                              const toScrape = Math.ceil(totalSelected * (scrapingConfig.percentagePerCategory / 100));
                              return toScrape;
                            })() / scrapingConfig.concurrent)}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Step 6: Scraping Companies */}
              {currentStep === 6 && (
                <div className="step-content">
                  <h2>🔄 Scraping Companies</h2>
                  
                  <div className="scraping-controls">
                    <div style={{marginTop: '24px'}}>
                      {!scrapingStatus.isRunning ? (
                        <button className="btn btn-primary" onClick={startScraping}>
                          Start Scraping
                        </button>
                      ) : (
                        <button className="btn btn-danger" onClick={stopScraping} style={{width: '100%'}}>
                          Stop Scraping
                        </button>
                      )}
                    </div>
                  </div>
                  
                  {/* Progress Section */}
                  {(scrapingStatus.isRunning || scrapingStatus.processedCompanies > 0) && (
                    <div className="progress-section">
                      <h3>Progress</h3>
                      
                      <div className="stats-grid">
                        <div className="stat-card">
                          <div className="stat-label">Total</div>
                          <div className="stat-value">{scrapingStatus.totalCompanies}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Processed</div>
                          <div className="stat-value">{scrapingStatus.processedCompanies}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Success</div>
                          <div className="stat-value" style={{color: '#10b981'}}>
                            {scrapingStatus.successCount}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Failed</div>
                          <div className="stat-value" style={{color: '#ef4444'}}>
                            {scrapingStatus.failedCount}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Skipped</div>
                          <div className="stat-value" style={{color: '#f59e0b'}}>
                            {scrapingStatus.skippedCount}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Speed</div>
                          <div className="stat-value" style={{fontSize: '18px'}}>
                            {scrapingStatus.companiesPerMinute}/min
                          </div>
                        </div>
                      </div>
                      
                      <div className="progress-bar-container">
                        <div 
                          className="progress-bar" 
                          style={{width: `${scrapingStatus.progress}%`}}
                        >
                          {scrapingStatus.progress.toFixed(1)}%
                        </div>
                      </div>
                      
                      {scrapingStatus.currentCompany && (
                        <div className="current-company">
                          <span><strong>Processing:</strong> {scrapingStatus.currentCompany}</span>
                          <span>ETA: {formatTime(scrapingStatus.estimatedTimeRemaining)}</span>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* Logs Section */}
                  {logs.length > 0 && (
                    <div className="logs-section">
                      <div className="logs-header">
                        <h3>Live Logs</h3>
                        <div className="log-filters">
                          <button 
                            className={`filter-btn ${logFilter === 'all' ? 'active' : ''}`}
                            onClick={() => setLogFilter('all')}
                          >
                            All
                          </button>
                          <button 
                            className={`filter-btn ${logFilter === 'success' ? 'active' : ''}`}
                            onClick={() => setLogFilter('success')}
                          >
                            Success
                          </button>
                          <button 
                            className={`filter-btn ${logFilter === 'error' ? 'active' : ''}`}
                            onClick={() => setLogFilter('error')}
                          >
                            Errors
                          </button>
                        </div>
                      </div>
                      <div className="logs-container">
                        {filteredLogs.map((log, index) => (
                          <div key={index} className="log-entry">
                            <span className="log-time">{formatLogTime(log.time)}</span>
                            <span className={`log-level ${log.level}`}>
                              {log.level?.toUpperCase()}
                            </span>
                            <span className="log-message">{log.message}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {/* Step 7: Results */}
              {currentStep === 7 && (
                <div className="step-content">
                  <h2>📊 Scraping Results</h2>
                  
                  {scrapingStatus.processedCompanies > 0 ? (
                    <div>
                      <div className="success-message">
                        ✅ Scraping completed successfully!
                      </div>
                      
                      <div className="stats-grid" style={{marginTop: '24px'}}>
                        <div className="stat-card">
                          <div className="stat-label">Total Processed</div>
                          <div className="stat-value">{scrapingStatus.processedCompanies}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Success Rate</div>
                          <div className="stat-value" style={{color: '#10b981'}}>
                            {((scrapingStatus.successCount / scrapingStatus.processedCompanies) * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Data Saved</div>
                          <div className="stat-value">{scrapingStatus.successCount}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Failed</div>
                          <div className="stat-value" style={{color: '#ef4444'}}>
                            {scrapingStatus.failedCount}
                          </div>
                        </div>
                      </div>
                      
                      <div className="info-box" style={{marginTop: '24px'}}>
                        <h4>Data Successfully Stored in Supabase</h4>
                        <p>
                          All scraped data has been saved to your Supabase database.<br/>
                          • Registration data<br/>
                          • Financial indicators<br/>
                          • Business results<br/>
                          • Year-over-year changes
                        </p>
                      </div>
                    </div>
                  ) : (
                    <div className="results-placeholder">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 17v1a3 3 0 003 3h0a3 3 0 003-3v-1m3-2l-3-3-3 3M12 12V3" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        <path d="M5 10a7 7 0 0114 0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      <h3>No Results Yet</h3>
                      <p>Complete the scraping process to see results here</p>
                    </div>
                  )}
                  
                </div>
              )}
            </div>
          </div>
          
          {/* Sticky Footer with Navigation */}
          <div className="sticky-footer">
            <div className="footer-content">
              <div className="navigation-buttons">
                {currentStep > 1 && (
                  <button 
                    className="nav-btn"
                    onClick={() => setCurrentStep(currentStep - 1)}
                  >
                    ← Back
                  </button>
                )}
              </div>
              
              <div className="navigation-buttons">
                {currentStep === 1 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(2)}
                    disabled={!authData.isAuthenticated}
                  >
                    Continue →
                  </button>
                )}
                
                {currentStep === 2 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(3)}
                  >
                    Next →
                  </button>
                )}
                
                {currentStep === 3 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(4)}
                    disabled={!fetchedActivities.fetched}
                  >
                    Continue →
                  </button>
                )}
                
                {currentStep === 4 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(5)}
                    disabled={scrapingConfig.selectedActivities.size === 0}
                  >
                    Configure Scraping →
                  </button>
                )}
                
                {currentStep === 5 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(6)}
                  >
                    Start Scraping →
                  </button>
                )}
                
                {currentStep === 6 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(7)}
                    disabled={scrapingStatus.isRunning || scrapingStatus.processedCompanies === 0}
                  >
                    View Results →
                  </button>
                )}
                
                {currentStep === 7 && (
                  <button 
                    className="nav-btn next"
                    onClick={() => setCurrentStep(1)}
                  >
                    Start New Session →
                  </button>
                )}
              </div>
            </div>
          </div>
          
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
  </script>
</body>
</html>