<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boniteti Scraper - Professional Dashboard</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* Sticky Stepper Navigation */
    .stepper-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 24px;
    }
    
    .stepper {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .stepper-header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .stepper-header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 8px;
    }
    
    .stepper-header p {
      color: #6b7280;
      font-size: 14px;
    }
    
    .steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 8px;
    }
    
    .steps::before {
      content: '';
      position: absolute;
      top: 24px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e5e7eb;
      z-index: -1;
    }
    
    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    
    .step-indicator {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border-radius: 50%;
      background: white;
      border: 3px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #9ca3af;
      transition: all 0.3s;
      position: relative;
      cursor: pointer;
    }
    
    .step.active .step-indicator {
      border-color: #667eea;
      color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    .step.completed .step-indicator {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }
    
    .step.completed .step-indicator::after {
      content: '✓';
      position: absolute;
      font-size: 20px;
    }
    
    .step.completed .step-indicator span {
      display: none;
    }
    
    .step-label {
      font-size: 14px;
      font-weight: 600;
      color: #9ca3af;
    }
    
    .step.active .step-label {
      color: #667eea;
    }
    
    .step.completed .step-label {
      color: #333;
    }
    
    .step-progress {
      position: absolute;
      top: 24px;
      left: 0;
      height: 2px;
      background: #667eea;
      transition: width 0.3s;
      z-index: -1;
    }
    
    /* Scrollable Content Area */
    .content-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      padding-bottom: 100px;
    }
    
    .content-wrapper {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .step-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .step-content h2 {
      font-size: 24px;
      margin-bottom: 24px;
      color: #333;
    }
    
    /* Step 1: Authentication */
    .auth-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group input.error {
      border-color: #ef4444;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 14px;
      margin-top: 4px;
    }
    
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn {
      padding: 12px 32px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #333;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Step 2: Scraping Controls */
    .scraping-controls {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .control-row {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .control-row label {
      min-width: 180px;
      font-weight: 600;
    }
    
    .control-row input[type="text"],
    .control-row input[type="number"],
    .control-row input[type="password"] {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .control-row input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .control-row input:disabled {
      background: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .checkbox-wrapper label {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: #667eea;
    }
    
    .info-box {
      background: #f0f9ff;
      border-left: 4px solid #667eea;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    
    .info-box h4 {
      color: #1e40af;
      margin-bottom: 8px;
    }
    
    .info-box p {
      color: #3730a3;
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* Progress Section */
    .progress-section {
      margin-top: 32px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .progress-bar-container {
      background: #f3f4f6;
      border-radius: 12px;
      height: 40px;
      overflow: hidden;
      position: relative;
      margin: 16px 0;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .current-company {
      padding: 12px;
      background: #f9fafb;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    /* Logs Section */
    .logs-section {
      margin-top: 32px;
      border-top: 2px solid #f3f4f6;
      padding-top: 24px;
    }
    
    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .log-filters {
      display: flex;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .logs-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      background: #fafafa;
    }
    
    .log-entry {
      padding: 8px;
      border-bottom: 1px solid #f3f4f6;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .log-time {
      color: #9ca3af;
      min-width: 70px;
      font-size: 11px;
    }
    
    .log-level {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      min-width: 50px;
      text-align: center;
    }
    
    .log-level.info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .log-level.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .log-level.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    /* Step 3: Results */
    .results-placeholder {
      text-align: center;
      padding: 48px;
    }
    
    .results-placeholder svg {
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
      opacity: 0.3;
    }
    
    .results-placeholder h3 {
      color: #6b7280;
      margin-bottom: 12px;
    }
    
    .results-placeholder p {
      color: #9ca3af;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f4f6;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Navigation Buttons */
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #f3f4f6;
    }
    
    .nav-btn {
      padding: 10px 24px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      color: #333;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-btn:hover:not(:disabled) {
      border-color: #667eea;
      color: #667eea;
    }
    
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .nav-btn.next {
      background: #667eea;
      color: white;
      border-color: #667eea;
      margin-left: auto;
    }
    
    .nav-btn.next:hover:not(:disabled) {
      background: #5a67d8;
    }
    
    /* Connection Status */
    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }
    
    .connection-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .connection-indicator.connected {
      background: #10b981;
    }
    
    .connection-indicator.disconnected {
      background: #ef4444;
      animation: none;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Comparison View Styles */
    .comparison-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .comparison-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .comparison-tab:hover {
      background: #f9fafb;
    }
    
    .comparison-tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
    }
    
    .comparison-tab .badge {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .comparison-tab.new .badge {
      background: #d1fae5;
      color: #065f46;
    }
    
    .comparison-tab.updated .badge {
      background: #fed7aa;
      color: #92400e;
    }
    
    .comparison-tab.unchanged .badge {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .comparison-tab.deleted .badge {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .comparison-content {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
    }
    
    .activity-item {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.2s;
    }
    
    .activity-item:hover {
      background: #f9fafb;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-item.new {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
    }
    
    .activity-item.updated {
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
    }
    
    .activity-item.deleted {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      opacity: 0.8;
    }
    
    .activity-code {
      font-weight: 600;
      color: #333;
      margin-right: 8px;
    }
    
    .activity-name {
      color: #6b7280;
    }
    
    .activity-change {
      margin-top: 8px;
      padding: 8px;
      background: white;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .change-field {
      display: flex;
      gap: 8px;
      margin: 4px 0;
    }
    
    .change-label {
      font-weight: 600;
      min-width: 60px;
    }
    
    .old-value {
      color: #ef4444;
      text-decoration: line-through;
    }
    
    .new-value {
      color: #10b981;
    }
    
    .sync-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid #f3f4f6;
    }
    
    .sync-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .sync-btn.accept-all {
      background: #10b981;
      color: white;
    }
    
    .sync-btn.accept-all:hover {
      background: #059669;
    }
    
    .sync-btn.reject {
      background: #f3f4f6;
      color: #333;
    }
    
    .sync-btn.reject:hover {
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    function Dashboard() {
      const [currentStep, setCurrentStep] = useState(1);
      const [isConnected, setIsConnected] = useState(false);
      const [authData, setAuthData] = useState({
        username: 'SR-03150321',
        password: '6413',
        isAuthenticated: false,
        sessionToken: null
      });
      const [activitiesData, setActivitiesData] = useState({
        fetched: false,
        loading: false,
        activities: [],
        totalCount: 0,
        comparison: null,
        showComparison: false,
        activeTab: 'all',
        error: null
      });
      const [scrapingConfig, setScrapingConfig] = useState({
        companies: 100,
        concurrent: 10,
        startId: 65000,
        scrapeAll: false,
        maxCompanies: null,
        loadingMax: false
      });
      const [scrapingStatus, setScrapingStatus] = useState({
        isRunning: false,
        totalCompanies: 0,
        processedCompanies: 0,
        successCount: 0,
        failedCount: 0,
        skippedCount: 0,
        currentCompany: null,
        progress: 0,
        companiesPerMinute: 0,
        estimatedTimeRemaining: null
      });
      const [logs, setLogs] = useState([]);
      const [logFilter, setLogFilter] = useState('all');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');
      const socketRef = useRef(null);
      
      useEffect(() => {
        // Connect to WebSocket
        const socket = io('http://localhost:3456');
        socketRef.current = socket;
        
        socket.on('connect', () => {
          setIsConnected(true);
        });
        
        socket.on('disconnect', () => {
          setIsConnected(false);
        });
        
        socket.on('status-update', (status) => {
          setScrapingStatus(status);
        });
        
        socket.on('progress-update', (data) => {
          setScrapingStatus(prev => ({
            ...prev,
            progress: data.progress,
            currentCompany: data.current,
            processedCompanies: data.processed,
            companiesPerMinute: data.companiesPerMinute,
            estimatedTimeRemaining: data.eta
          }));
        });
        
        socket.on('company-scraped', (data) => {
          if (data.status === 'success') {
            setScrapingStatus(prev => ({ ...prev, successCount: prev.successCount + 1 }));
          } else if (data.status === 'failed') {
            setScrapingStatus(prev => ({ ...prev, failedCount: prev.failedCount + 1 }));
          } else if (data.status === 'skipped') {
            setScrapingStatus(prev => ({ ...prev, skippedCount: prev.skippedCount + 1 }));
          }
        });
        
        socket.on('log-entry', (log) => {
          setLogs(prev => [...prev.slice(-99), log]);
        });
        
        socket.on('scraping-complete', (data) => {
          setScrapingStatus(prev => ({ ...prev, isRunning: false }));
          if (data.success) {
            // Auto advance to results
            setTimeout(() => setCurrentStep(3), 1000);
          }
        });
        
        return () => {
          socket.disconnect();
        };
      }, []);
      
      const handleLogin = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');
        
        // Simulate authentication with Boniteti
        // In production, this would make a real API call to get session
        setTimeout(() => {
          if (authData.username && authData.password) {
            setAuthData(prev => ({
              ...prev,
              isAuthenticated: true,
              sessionToken: 'mock-session-token-' + Date.now()
            }));
            setIsLoading(false);
            // Auto advance to next step
            setTimeout(() => setCurrentStep(2), 500);
          } else {
            setError('Please enter both username and password');
            setIsLoading(false);
          }
        }, 1500);
      };
      
      const fetchMaxCompanies = async () => {
        try {
          const response = await fetch('https://www.boniteti.me/api/total-companies');
          const data = await response.json();
          return data.total || 65000;
        } catch (error) {
          console.error('Failed to fetch max companies:', error);
          return 65000; // Default fallback
        }
      };
      
      const handleScrapeAllToggle = async () => {
        const newScrapeAll = !scrapingConfig.scrapeAll;
        setScrapingConfig(prev => ({ 
          ...prev, 
          scrapeAll: newScrapeAll,
          loadingMax: newScrapeAll
        }));
        
        if (newScrapeAll) {
          // Fetch max companies from API
          const maxCompanies = await fetchMaxCompanies();
          setScrapingConfig(prev => ({ 
            ...prev, 
            companies: maxCompanies,
            maxCompanies: maxCompanies,
            loadingMax: false
          }));
        } else {
          // Reset to default when unchecked
          setScrapingConfig(prev => ({ 
            ...prev, 
            companies: 100,
            maxCompanies: null,
            loadingMax: false
          }));
        }
      };
      
      const startScraping = () => {
        const companiesToScrape = scrapingConfig.scrapeAll 
          ? scrapingConfig.maxCompanies 
          : parseInt(scrapingConfig.companies);
          
        socketRef.current.emit('start-scraping', {
          companies: companiesToScrape,
          concurrent: parseInt(scrapingConfig.concurrent),
          startId: parseInt(scrapingConfig.startId),
          sessionToken: authData.sessionToken,
          testMode: false
        });
      };
      
      const stopScraping = () => {
        if (confirm('Are you sure you want to stop scraping?')) {
          socketRef.current.emit('stop-scraping');
        }
      };
      
      const fetchActivities = async () => {
        setActivitiesData(prev => ({ ...prev, loading: true, error: null }));
        
        try {
          const response = await fetch('http://localhost:3456/api/compare-activities', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          if (data.comparison) {
            // Get all activities from database after update
            const activitiesResponse = await fetch('http://localhost:3456/api/activities');
            let activities = [];
            
            if (activitiesResponse.ok) {
              const result = await activitiesResponse.json();
              activities = Array.isArray(result) ? result : [];
            }
            
            setActivitiesData({
              fetched: true,
              loading: false,
              activities: activities,
              totalCount: activities.length,
              comparison: data.comparison,
              showComparison: true,
              error: null
            });
            
            // Don't auto-advance if there are changes to review
            if (data.stats.new === 0 && data.stats.updated === 0 && data.stats.deleted === 0) {
              setTimeout(() => setCurrentStep(3), 1500);
            }
          } else if (data.success) {
            // Fallback if no comparison data
            const activitiesResponse = await fetch('http://localhost:3456/api/activities');
            let activities = [];
            
            if (activitiesResponse.ok) {
              const result = await activitiesResponse.json();
              activities = Array.isArray(result) ? result : [];
            }
            
            setActivitiesData({
              fetched: true,
              loading: false,
              activities: activities,
              totalCount: activities.length,
              comparison: null,
              showComparison: false,
              error: null
            });
            
            setTimeout(() => setCurrentStep(3), 500);
          } else {
            throw new Error(data.error || 'Failed to fetch activities');
          }
        } catch (error) {
          setActivitiesData(prev => ({
            ...prev,
            loading: false,
            error: error.message
          }));
        }
      };
      
      const formatTime = (ms) => {
        if (!ms) return '--';
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
          return `${hours}h ${minutes % 60}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${seconds % 60}s`;
        } else {
          return `${seconds}s`;
        }
      };
      
      const formatLogTime = (time) => {
        const date = new Date(time);
        return date.toLocaleTimeString('en-US', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      };
      
      const filteredLogs = logs.filter(log => {
        if (logFilter === 'all') return true;
        return log.level === logFilter;
      });
      
      const canProceedToNext = () => {
        if (currentStep === 1) return authData.isAuthenticated;
        if (currentStep === 2) return activitiesData.fetched;
        if (currentStep === 3) return scrapingStatus.processedCompanies > 0 && !scrapingStatus.isRunning;
        return false;
      };
      
      const goToStep = (step) => {
        if (step === 1) {
          setCurrentStep(1);
        } else if (step === 2 && authData.isAuthenticated) {
          setCurrentStep(2);
        } else if (step === 3 && authData.isAuthenticated && activitiesData.fetched) {
          setCurrentStep(3);
        } else if (step === 4 && authData.isAuthenticated && activitiesData.fetched && scrapingStatus.processedCompanies > 0) {
          setCurrentStep(4);
        }
      };
      
      return (
        <div className="app-container">
          {/* Sticky Stepper Navigation */}
          <div className="stepper-container">
            <div className="stepper">
              <div className="stepper-header">
                <h1>🚀 Boniteti Professional Scraper</h1>
                <p>Automated data extraction from Boniteti.me</p>
              </div>
              
              <div className="steps">
                <div 
                  className={`step ${currentStep === 1 ? 'active' : ''} ${authData.isAuthenticated ? 'completed' : ''}`}
                  onClick={() => goToStep(1)}
                >
                  <div className="step-indicator">
                    <span>1</span>
                  </div>
                  <div className="step-label">Authentication</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 2 ? 'active' : ''} ${activitiesData.fetched ? 'completed' : ''}`}
                  onClick={() => goToStep(2)}
                >
                  <div className="step-indicator">
                    <span>2</span>
                  </div>
                  <div className="step-label">Activities</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 3 ? 'active' : ''} ${scrapingStatus.processedCompanies > 0 && !scrapingStatus.isRunning ? 'completed' : ''}`}
                  onClick={() => goToStep(3)}
                >
                  <div className="step-indicator">
                    <span>3</span>
                  </div>
                  <div className="step-label">Scraping</div>
                </div>
                
                <div 
                  className={`step ${currentStep === 4 ? 'active' : ''}`}
                  onClick={() => goToStep(4)}
                >
                  <div className="step-indicator">
                    <span>4</span>
                  </div>
                  <div className="step-label">Results</div>
                </div>
                
                <div 
                  className="step-progress" 
                  style={{
                    width: `${((currentStep - 1) / 3) * 100}%`
                  }}
                />
              </div>
            </div>
          </div>
          
          {/* Scrollable Content Area */}
          <div className="content-container">
            <div className="content-wrapper">
              {/* Step 1: Authentication */}
              {currentStep === 1 && (
                <div className="step-content">
                  <h2>🔐 Authenticate with Boniteti</h2>
                  
                  {authData.isAuthenticated ? (
                    <div className="success-message">
                      ✅ Successfully authenticated! Session token obtained.
                    </div>
                  ) : null}
                  
                  <div className="auth-form">
                    <form onSubmit={handleLogin}>
                      <div className="form-group">
                        <label htmlFor="username">Username</label>
                        <input
                          type="text"
                          id="username"
                          placeholder="Enter your Boniteti username"
                          value={authData.username}
                          onChange={(e) => setAuthData(prev => ({ ...prev, username: e.target.value }))}
                          disabled={authData.isAuthenticated}
                          className={error && !authData.username ? 'error' : ''}
                        />
                      </div>
                      
                      <div className="form-group">
                        <label htmlFor="password">Password</label>
                        <input
                          type="password"
                          id="password"
                          placeholder="Enter your password"
                          value={authData.password}
                          onChange={(e) => setAuthData(prev => ({ ...prev, password: e.target.value }))}
                          disabled={authData.isAuthenticated}
                          className={error && !authData.password ? 'error' : ''}
                        />
                      </div>
                      
                      {error && (
                        <div className="error-message">{error}</div>
                      )}
                      
                      {!authData.isAuthenticated && (
                        <button 
                          type="submit" 
                          className="btn btn-primary"
                          disabled={isLoading}
                        >
                          {isLoading ? (
                            <>Authenticating... <span className="spinner"></span></>
                          ) : (
                            'Authenticate'
                          )}
                        </button>
                      )}
                    </form>
                    
                    {authData.isAuthenticated && (
                      <div className="navigation-buttons">
                        <button 
                          className="nav-btn next"
                          onClick={() => setCurrentStep(2)}
                        >
                          Continue to Scraping →
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              {/* Step 2: Activities */}
              {currentStep === 2 && (
                <div className="step-content">
                  <h2>📂 Fetch Activity Sectors</h2>
                  
                  <div className="info-box">
                    <h4>Why Activities Are Important</h4>
                    <p>
                      Activity sectors (delatnosti) categorize companies by their business type.<br/>
                      This data is essential for filtering and organizing companies during scraping.
                    </p>
                  </div>
                  
                  {!activitiesData.fetched && !activitiesData.loading && (
                    <div style={{textAlign: 'center', padding: '48px'}}>
                      <p style={{marginBottom: '24px', color: '#6b7280'}}>
                        Click the button below to fetch all activity sectors from Boniteti.me
                      </p>
                      <button 
                        className="btn btn-primary"
                        onClick={fetchActivities}
                        style={{width: 'auto', padding: '12px 48px'}}
                      >
                        Fetch Activities
                      </button>
                    </div>
                  )}
                  
                  {activitiesData.loading && (
                    <div style={{textAlign: 'center', padding: '48px'}}>
                      <div className="spinner" style={{width: '48px', height: '48px', borderWidth: '4px'}}></div>
                      <p style={{marginTop: '24px', color: '#6b7280'}}>
                        Fetching activity sectors from Boniteti API...
                      </p>
                    </div>
                  )}
                  
                  {activitiesData.error && (
                    <div className="error-message" style={{margin: '24px', padding: '16px'}}>
                      Error: {activitiesData.error}
                      <button 
                        className="btn btn-secondary"
                        onClick={fetchActivities}
                        style={{marginTop: '12px'}}
                      >
                        Try Again
                      </button>
                    </div>
                  )}
                  
                  {activitiesData.fetched && (
                    <div>
                      {activitiesData.comparison ? (
                        <>
                          <div className="success-message">
                            ✅ Successfully compared activities with database!
                          </div>
                          
                          <div className="stats-grid" style={{marginTop: '24px'}}>
                            <div className="stat-card">
                              <div className="stat-label">New Activities</div>
                              <div className="stat-value" style={{color: '#10b981'}}>
                                {activitiesData.comparison.new.length}
                              </div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Updated</div>
                              <div className="stat-value" style={{color: '#f59e0b'}}>
                                {activitiesData.comparison.updated.length}
                              </div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Unchanged</div>
                              <div className="stat-value" style={{color: '#3b82f6'}}>
                                {activitiesData.comparison.unchanged.length}
                              </div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Deleted</div>
                              <div className="stat-value" style={{color: '#ef4444'}}>
                                {activitiesData.comparison.deleted.length}
                              </div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Total in DB</div>
                              <div className="stat-value">{activitiesData.totalCount}</div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">From API</div>
                              <div className="stat-value">
                                {(activitiesData.comparison.new.length + 
                                  activitiesData.comparison.updated.length + 
                                  activitiesData.comparison.unchanged.length)}
                              </div>
                            </div>
                          </div>
                          
                          <div className="comparison-tabs">
                            <button 
                              className={`comparison-tab ${activitiesData.activeTab === 'all' ? 'active' : ''}`}
                              onClick={() => setActivitiesData(prev => ({ ...prev, activeTab: 'all' }))}
                            >
                              All Activities
                              <span className="badge" style={{background: '#e5e7eb', color: '#333'}}>
                                {activitiesData.totalCount}
                              </span>
                            </button>
                            <button 
                              className={`comparison-tab new ${activitiesData.activeTab === 'new' ? 'active' : ''}`}
                              onClick={() => setActivitiesData(prev => ({ ...prev, activeTab: 'new' }))}
                            >
                              New
                              <span className="badge">{activitiesData.comparison.new.length}</span>
                            </button>
                            <button 
                              className={`comparison-tab updated ${activitiesData.activeTab === 'updated' ? 'active' : ''}`}
                              onClick={() => setActivitiesData(prev => ({ ...prev, activeTab: 'updated' }))}
                            >
                              Updated
                              <span className="badge">{activitiesData.comparison.updated.length}</span>
                            </button>
                            <button 
                              className={`comparison-tab unchanged ${activitiesData.activeTab === 'unchanged' ? 'active' : ''}`}
                              onClick={() => setActivitiesData(prev => ({ ...prev, activeTab: 'unchanged' }))}
                            >
                              Unchanged
                              <span className="badge">{activitiesData.comparison.unchanged.length}</span>
                            </button>
                            <button 
                              className={`comparison-tab deleted ${activitiesData.activeTab === 'deleted' ? 'active' : ''}`}
                              onClick={() => setActivitiesData(prev => ({ ...prev, activeTab: 'deleted' }))}
                            >
                              Deleted
                              <span className="badge">{activitiesData.comparison.deleted.length}</span>
                            </button>
                          </div>
                          
                          <div className="comparison-content">
                            {activitiesData.activeTab === 'all' && (
                              <div>
                                {Array.isArray(activitiesData.activities) && activitiesData.activities.length > 0 ? (
                                  <>
                                    {activitiesData.activities.slice(0, 50).map((activity, index) => (
                                      <div key={index} className="activity-item">
                                        <span className="activity-code">{activity.code}</span>
                                        <span className="activity-name">{activity.name}</span>
                                      </div>
                                    ))}
                                    {activitiesData.totalCount > 50 && (
                                      <p style={{marginTop: '12px', textAlign: 'center', color: '#6b7280'}}>
                                        Showing 50 of {activitiesData.totalCount} activities
                                      </p>
                                    )}
                                  </>
                                ) : (
                                  <p style={{textAlign: 'center', color: '#6b7280', padding: '24px'}}>
                                    No activities in database yet
                                  </p>
                                )}
                              </div>
                            )}
                            
                            {activitiesData.activeTab === 'new' && (
                              <div>
                                {activitiesData.comparison.new.length > 0 ? (
                                  activitiesData.comparison.new.map((activity, index) => (
                                    <div key={index} className="activity-item new">
                                      <span className="activity-code">{activity.code}</span>
                                      <span className="activity-name">{activity.name}</span>
                                    </div>
                                  ))
                                ) : (
                                  <p style={{textAlign: 'center', color: '#6b7280', padding: '24px'}}>
                                    No new activities found
                                  </p>
                                )}
                              </div>
                            )}
                            
                            {activitiesData.activeTab === 'updated' && (
                              <div>
                                {activitiesData.comparison.updated.length > 0 ? (
                                  activitiesData.comparison.updated.map((activity, index) => (
                                    <div key={index} className="activity-item updated">
                                      <div>
                                        <span className="activity-code">{activity.code}</span>
                                        <span className="activity-name">{activity.name}</span>
                                      </div>
                                      {activity.old && (
                                        <div className="activity-change">
                                          {activity.old.name !== activity.name && (
                                            <div className="change-field">
                                              <span className="change-label">Name:</span>
                                              <span className="old-value">{activity.old.name}</span>
                                              <span>→</span>
                                              <span className="new-value">{activity.name}</span>
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  ))
                                ) : (
                                  <p style={{textAlign: 'center', color: '#6b7280', padding: '24px'}}>
                                    No updated activities
                                  </p>
                                )}
                              </div>
                            )}
                            
                            {activitiesData.activeTab === 'unchanged' && (
                              <div>
                                {activitiesData.comparison.unchanged.slice(0, 50).map((activity, index) => (
                                  <div key={index} className="activity-item">
                                    <span className="activity-code">{activity.code}</span>
                                    <span className="activity-name">{activity.name}</span>
                                  </div>
                                ))}
                                {activitiesData.comparison.unchanged.length > 50 && (
                                  <p style={{marginTop: '12px', textAlign: 'center', color: '#6b7280'}}>
                                    Showing 50 of {activitiesData.comparison.unchanged.length} unchanged activities
                                  </p>
                                )}
                              </div>
                            )}
                            
                            {activitiesData.activeTab === 'deleted' && (
                              <div>
                                {activitiesData.comparison.deleted.length > 0 ? (
                                  activitiesData.comparison.deleted.map((activity, index) => (
                                    <div key={index} className="activity-item deleted">
                                      <span className="activity-code">{activity.code}</span>
                                      <span className="activity-name">{activity.name}</span>
                                      <div style={{fontSize: '12px', color: '#ef4444', marginTop: '4px'}}>
                                        This activity exists in database but not in API response
                                      </div>
                                    </div>
                                  ))
                                ) : (
                                  <p style={{textAlign: 'center', color: '#6b7280', padding: '24px'}}>
                                    No deleted activities
                                  </p>
                                )}
                              </div>
                            )}
                          </div>
                          
                          {(activitiesData.comparison.new.length > 0 || 
                            activitiesData.comparison.updated.length > 0 || 
                            activitiesData.comparison.deleted.length > 0) && (
                            <div className="sync-actions">
                              <button className="sync-btn accept-all">
                                ✓ Accept All Changes
                              </button>
                              <button className="sync-btn reject">
                                Skip Changes
                              </button>
                              <div style={{marginLeft: 'auto', fontSize: '14px', color: '#6b7280', alignSelf: 'center'}}>
                                Changes are automatically saved to database
                              </div>
                            </div>
                          )}
                        </>
                      ) : (
                        // Fallback simple view if no comparison data
                        <div>
                          <div className="success-message">
                            ✅ Successfully fetched {activitiesData.totalCount} activity sectors!
                          </div>
                          
                          <div className="stats-grid" style={{marginTop: '24px'}}>
                            <div className="stat-card">
                              <div className="stat-label">Total Activities</div>
                              <div className="stat-value">{activitiesData.totalCount}</div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Main Sectors</div>
                              <div className="stat-value">
                                {Array.isArray(activitiesData.activities) 
                                  ? activitiesData.activities.filter(a => !a.parent_id).length 
                                  : 0}
                              </div>
                            </div>
                            <div className="stat-card">
                              <div className="stat-label">Sub-sectors</div>
                              <div className="stat-value">
                                {Array.isArray(activitiesData.activities) 
                                  ? activitiesData.activities.filter(a => a.parent_id).length 
                                  : 0}
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  
                  <div className="navigation-buttons">
                    <button 
                      className="nav-btn"
                      onClick={() => setCurrentStep(1)}
                    >
                      ← Back
                    </button>
                    <button 
                      className="nav-btn next"
                      onClick={() => setCurrentStep(3)}
                      disabled={!canProceedToNext()}
                    >
                      Continue to Scraping →
                    </button>
                  </div>
                </div>
              )}
              
              {/* Step 3: Scraping */}
              {currentStep === 3 && (
                <div className="step-content">
                  <h2>⚙️ Configure & Start Scraping</h2>
                  
                  <div className="scraping-controls">
                    <div className="info-box">
                      <h4>Session Active</h4>
                      <p>
                        Authenticated as: <strong>{authData.username}</strong><br/>
                        Ready to start scraping from ID {scrapingConfig.startId} backwards<br/>
                        {scrapingConfig.scrapeAll && scrapingConfig.maxCompanies && (
                          <>
                            <strong style={{color: '#667eea'}}>
                              Will scrape ALL {scrapingConfig.maxCompanies.toLocaleString()} companies
                            </strong>
                          </>
                        )}
                      </p>
                    </div>
                    
                    <div className="control-row">
                      <label>Number of Companies:</label>
                      <input 
                        type="number" 
                        value={scrapingConfig.companies}
                        onChange={(e) => setScrapingConfig(prev => ({ ...prev, companies: e.target.value }))}
                        disabled={scrapingStatus.isRunning || scrapingConfig.scrapeAll}
                      />
                      <div className="checkbox-wrapper">
                        <input 
                          type="checkbox" 
                          id="scrapeAll"
                          checked={scrapingConfig.scrapeAll}
                          onChange={handleScrapeAllToggle}
                          disabled={scrapingStatus.isRunning || scrapingConfig.loadingMax}
                        />
                        <label htmlFor="scrapeAll">
                          {scrapingConfig.loadingMax ? (
                            <>Loading... <span className="spinner"></span></>
                          ) : (
                            'All Companies'
                          )}
                        </label>
                      </div>
                    </div>
                    
                    <div className="control-row">
                      <label>Starting ID:</label>
                      <input 
                        type="number" 
                        value={scrapingConfig.startId}
                        onChange={(e) => setScrapingConfig(prev => ({ ...prev, startId: e.target.value }))}
                        disabled={scrapingStatus.isRunning}
                      />
                    </div>
                    
                    <div className="control-row">
                      <label>Concurrent Requests:</label>
                      <input 
                        type="number" 
                        value={scrapingConfig.concurrent}
                        onChange={(e) => setScrapingConfig(prev => ({ ...prev, concurrent: e.target.value }))}
                        disabled={scrapingStatus.isRunning}
                      />
                    </div>
                    
                    <div style={{marginTop: '24px'}}>
                      {!scrapingStatus.isRunning ? (
                        <button className="btn btn-primary" onClick={startScraping}>
                          Start Scraping
                        </button>
                      ) : (
                        <button className="btn btn-danger" onClick={stopScraping} style={{width: '100%'}}>
                          Stop Scraping
                        </button>
                      )}
                    </div>
                  </div>
                  
                  {/* Progress Section */}
                  {(scrapingStatus.isRunning || scrapingStatus.processedCompanies > 0) && (
                    <div className="progress-section">
                      <h3>Progress</h3>
                      
                      <div className="stats-grid">
                        <div className="stat-card">
                          <div className="stat-label">Total</div>
                          <div className="stat-value">{scrapingStatus.totalCompanies}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Processed</div>
                          <div className="stat-value">{scrapingStatus.processedCompanies}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Success</div>
                          <div className="stat-value" style={{color: '#10b981'}}>
                            {scrapingStatus.successCount}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Failed</div>
                          <div className="stat-value" style={{color: '#ef4444'}}>
                            {scrapingStatus.failedCount}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Skipped</div>
                          <div className="stat-value" style={{color: '#f59e0b'}}>
                            {scrapingStatus.skippedCount}
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Speed</div>
                          <div className="stat-value" style={{fontSize: '18px'}}>
                            {scrapingStatus.companiesPerMinute}/min
                          </div>
                        </div>
                      </div>
                      
                      <div className="progress-bar-container">
                        <div 
                          className="progress-bar" 
                          style={{width: `${scrapingStatus.progress}%`}}
                        >
                          {scrapingStatus.progress.toFixed(1)}%
                        </div>
                      </div>
                      
                      {scrapingStatus.currentCompany && (
                        <div className="current-company">
                          <span><strong>Processing:</strong> {scrapingStatus.currentCompany}</span>
                          <span>ETA: {formatTime(scrapingStatus.estimatedTimeRemaining)}</span>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* Logs Section */}
                  {logs.length > 0 && (
                    <div className="logs-section">
                      <div className="logs-header">
                        <h3>Live Logs</h3>
                        <div className="log-filters">
                          <button 
                            className={`filter-btn ${logFilter === 'all' ? 'active' : ''}`}
                            onClick={() => setLogFilter('all')}
                          >
                            All
                          </button>
                          <button 
                            className={`filter-btn ${logFilter === 'success' ? 'active' : ''}`}
                            onClick={() => setLogFilter('success')}
                          >
                            Success
                          </button>
                          <button 
                            className={`filter-btn ${logFilter === 'error' ? 'active' : ''}`}
                            onClick={() => setLogFilter('error')}
                          >
                            Errors
                          </button>
                        </div>
                      </div>
                      <div className="logs-container">
                        {filteredLogs.map((log, index) => (
                          <div key={index} className="log-entry">
                            <span className="log-time">{formatLogTime(log.time)}</span>
                            <span className={`log-level ${log.level}`}>
                              {log.level?.toUpperCase()}
                            </span>
                            <span className="log-message">{log.message}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Navigation */}
                  <div className="navigation-buttons">
                    <button 
                      className="nav-btn"
                      onClick={() => setCurrentStep(2)}
                    >
                      ← Back
                    </button>
                    <button 
                      className="nav-btn next"
                      onClick={() => setCurrentStep(4)}
                      disabled={!canProceedToNext()}
                    >
                      View Results →
                    </button>
                  </div>
                </div>
              )}
              
              {/* Step 4: Results */}
              {currentStep === 4 && (
                <div className="step-content">
                  <h2>📊 Scraping Results</h2>
                  
                  {scrapingStatus.processedCompanies > 0 ? (
                    <div>
                      <div className="success-message">
                        ✅ Scraping completed successfully!
                      </div>
                      
                      <div className="stats-grid" style={{marginTop: '24px'}}>
                        <div className="stat-card">
                          <div className="stat-label">Total Processed</div>
                          <div className="stat-value">{scrapingStatus.processedCompanies}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Success Rate</div>
                          <div className="stat-value" style={{color: '#10b981'}}>
                            {((scrapingStatus.successCount / scrapingStatus.processedCompanies) * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Data Saved</div>
                          <div className="stat-value">{scrapingStatus.successCount}</div>
                        </div>
                        <div className="stat-card">
                          <div className="stat-label">Failed</div>
                          <div className="stat-value" style={{color: '#ef4444'}}>
                            {scrapingStatus.failedCount}
                          </div>
                        </div>
                      </div>
                      
                      <div className="info-box" style={{marginTop: '24px'}}>
                        <h4>Data Successfully Stored in Supabase</h4>
                        <p>
                          All scraped data has been saved to your Supabase database.<br/>
                          • Registration data<br/>
                          • Financial indicators<br/>
                          • Business results<br/>
                          • Year-over-year changes
                        </p>
                      </div>
                    </div>
                  ) : (
                    <div className="results-placeholder">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 17v1a3 3 0 003 3h0a3 3 0 003-3v-1m3-2l-3-3-3 3M12 12V3" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        <path d="M5 10a7 7 0 0114 0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      <h3>No Results Yet</h3>
                      <p>Complete the scraping process to see results here</p>
                    </div>
                  )}
                  
                  <div className="navigation-buttons">
                    <button 
                      className="nav-btn"
                      onClick={() => setCurrentStep(3)}
                    >
                      ← Back to Scraping
                    </button>
                    <button 
                      className="btn btn-primary"
                      onClick={() => {
                        // Reset everything for a new session
                        setCurrentStep(3);
                        setScrapingStatus({
                          isRunning: false,
                          totalCompanies: 0,
                          processedCompanies: 0,
                          successCount: 0,
                          failedCount: 0,
                          skippedCount: 0,
                          currentCompany: null,
                          progress: 0,
                          companiesPerMinute: 0,
                          estimatedTimeRemaining: null
                        });
                        setLogs([]);
                      }}
                      style={{marginLeft: 'auto'}}
                    >
                      Start New Scraping Session
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
          
          {/* Connection Status */}
          <div className="connection-status">
            <div className={`connection-indicator ${isConnected ? 'connected' : 'disconnected'}`}></div>
            <span>{isConnected ? 'Connected' : 'Disconnected'}</span>
          </div>
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
  </script>
</body>
</html>